
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>VMware Tanzu Application Service (Cloud Foundry) Hands-on Lab</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-77753174-1"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="tas-for-vms-hol"
                  title="VMware Tanzu Application Service (Cloud Foundry) Hands-on Lab"
                  environment="web"
                  feedback-link="https://docs.google.com/document/d/1bNd_n7fOyV1Axbi6AlLnhjyl-_PJkRXXd2h7jgujNEw/edit?usp=sharing">
    
      <google-codelab-step label="Hands-on Labã«å¿…è¦ãªã‚‚ã®" duration="10">
        <p>ã“ã®Hands-on Labè³‡æ–™ã¯ã€æº–å‚™æ¸ˆã¿ã®<a href="https://network.pivotal.io/products/elastic-runtime" target="_blank">Tanzu Application Service for VMs</a>ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ãŒã€<a href="https://run.pivotal.io" target="_blank">Pivotal Web Services</a>ãªã©ã€ãã®ä»–ã®Cloud Foundryç’°å¢ƒã§ã‚‚å¤šãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
<p>ä»¥ä¸‹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚</p>
<ul>
<li><a href="https://bell-sw.com/pages/downloads/#/java-11-lts" target="_blank">Java 11</a></li>
<li>CF CLI (v6, v7)</li>
<li><a href="https://curl.haxx.se/" target="_blank"><code>curl</code></a></li>
<li><a href="https://stedolan.github.io/jq/" target="_blank"><code>jq</code></a></li>
<li><code>tar</code></li>
</ul>
<p>CF CLI (v6)ã¯<a href="https://github.com/cloudfoundry/cli/releases/tag/v6.51.0" target="_blank">ã“ã¡ã‚‰</a>ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf -v
cf version 6.51.0+2acd15650.2020-04-07</code></pre>
<p><br>CF CLI (v7)ã¯<a href="https://github.com/cloudfoundry/cli/releases/tag/v7.0.1" target="_blank">ã“ã¡ã‚‰</a>ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚cf7ã¨ã„ã†åå‰ã§ä½¿ç”¨ã—ã¾ã™ã€‚</p>
<pre><code>$ cf7 -v                                        
cf7 version 7.0.1+fb3f929c2.2020-06-24</code></pre>
<aside class="warning"><p>Note: <code>cf7</code>ãŒæ­£å¼ã«åˆ©ç”¨ã§ãã‚‹ã®ã¯<a href="https://docs.pivotal.io/platform/2-10/release-notes/runtime-rn.html#cf-cli" target="_blank">TAS 2.10</a>ã‹ã‚‰ã§ã™ã€‚</p>
</aside>
<aside class="special"><p>Note: åŸ·ç­†æ™‚ã«å‹•ä½œç¢ºèªã—ãŸç’°å¢ƒã«ã¯æ¬¡ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<ul>
<li><a href="https://network.pivotal.io/products/elastic-runtime" target="_blank">Tanzu Application Service for VMs</a> 2.8.9</li>
<li><a href="https://network.pivotal.io/products/credhub-service-broker" target="_blank">Credhub Service Broker</a> 1.4.8</li>
<li><a href="https://network.pivotal.io/products/apm" target="_blank">App Metrics</a> 2.0.2</li>
<li><a href="https://network.pivotal.io/products/p-metric-store" target="_blank">Metric Store</a> 1.4.2</li>
<li><a href="https://github.com/making/elephantsql-service-broker" target="_blank">ElephantSQL Service Broker</a></li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Tanzu Application Serviceã«ãƒ­ã‚°ã‚¤ãƒ³" duration="15">
        <p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Hands-on Labç”¨ã®ç’°å¢ƒã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚</p>
<pre><code>cf login -a api.sys.dev.example.com -o hol --sso</code></pre>
<aside class="warning"><p>Note: <code>ç”¨æ„</code>ã•ã‚ŒãŸHands-on Labç”¨ã®ç’°å¢ƒä»¥å¤–ã®ç’°å¢ƒã§å®Ÿæ–½ã™ã‚‹å ´åˆã¯ã€ãã®ç’°å¢ƒã«åˆã‚ã›ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
</aside>
<p>æ¬¡ã®ã‚ˆã†ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã®å…¥åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã®ã§ã€<a href="https://login.sys.dev.example.com/passcode" target="_blank">https://login.sys.dev.example.com/passcode</a>ã«SSOã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>API endpoint: api.sys.dev.example.com

Temporary Authentication Code ( Get one at https://login.sys.dev.example.com/passcode ): </code></pre>
<p>èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã—ã€æ¬¡ã®ã‚ˆã†ã«è‡ªå‹•ã§SpaceãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>Authenticating...
OK


Targeted org hol

Targeted space tmaki



API endpoint:   https://api.sys.dev.example.com (API version: 3.77.0)
User:           tmaki@pivotal.io
Org:            hol
Space:          tmaki</code></pre>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ç’°å¢ƒã®æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf curl /info
{
   &#34;name&#34;: &#34;Pivotal Application Service&#34;,
   &#34;build&#34;: &#34;2.8.9-build.3&#34;,
   &#34;support&#34;: &#34;https://support.pivotal.io&#34;,
   &#34;version&#34;: 0,
   &#34;description&#34;: &#34;https://docs.pivotal.io/pivotalcf/2-8/pcf-release-notes/runtime-rn.html&#34;,
   &#34;authorization_endpoint&#34;: &#34;https://login.sys.dev.example.com&#34;,
   &#34;token_endpoint&#34;: &#34;https://uaa.sys.dev.example.com&#34;,
   &#34;allow_debug&#34;: true,
   &#34;user&#34;: &#34;4662f460-8b18-45b1-bde8-c409c4e6b123&#34;,
   &#34;limits&#34;: {
      &#34;memory&#34;: 2048,
      &#34;app_uris&#34;: 4,
      &#34;services&#34;: 16,
      &#34;apps&#34;: 20
   },
   &#34;usage&#34;: {
      &#34;memory&#34;: 0,
      &#34;apps&#34;: 0,
      &#34;services&#34;: 0
   }
}</code></pre>
<aside class="warning"><p>Note: Windowsã§Git Bashã‚’ä½¿ã†å ´åˆã¯<br><code>export MSYS_NO_PATHCONV=1</code></p>
<p>ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
</aside>
<aside class="special"><p>Note: TAS 2.9ã‹ã‚‰ã¯<code>name</code>ãŒ<code>VMware Tanzu Application Service</code>ã«ãªã‚Šã¾ã™ã€‚</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="é››å½¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤" duration="30">
        <h2 is-upgraded>Spring Initialzrã§é››å½¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ</h2>
<p><a href="https://start.spring.io" target="_blank">Spring Initializr</a>ã§Spring Bootã®é››å½¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€cf pushã§æ—©é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<p>ä½œæ¥­å ´æ‰€ã¨ã—ã¦<code>hol</code>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>mkdir hol
cd hol</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§é››å½¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<pre><code>curl https://start.spring.io/starter.tgz \
       -d artifactId=hello-cf \
       -d baseDir=hello-cf \
       -d dependencies=web,actuator,configuration-processor,prometheus \
       -d packageName=com.example \
       -d applicationName=HelloCfApplication | tar -xzvf -</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚</p>
<pre><code>cd hello-cf
./mvnw clean package -Dmaven.test.skip=true</code></pre>
<aside class="warning"><p>Note: Windowsã§Git Bashã‚’ä½¿ã†å ´åˆã¯<code>./mvnw</code>ã®ä»£ã‚ã‚Šã«<code>./mvnw.cmd</code>ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</p>
</aside>
<h2 is-upgraded><br>cf pushã§ãƒ‡ãƒ—ãƒ­ã‚¤</h2>
<p><code>hello-cf</code>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã«<code>manifest.yml</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;</code></pre>
<aside class="warning"><p>Note: Hands-on Labã§ã¯è¤‡æ•°ã®äººãŒåŒã˜nameã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLã®Hostéƒ¨åˆ†ãŒnameã¨åŒã˜ã«ãªã‚‹ãŸã‚ã€URLã®è¡çªãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã‚Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«<code>random-route: true</code>ã‚’ã¤ã‘ã¦ã€Hostéƒ¨åˆ†ã«ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’è¿½è¨˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
</aside>
<p><code>cf push</code>ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<pre><code>cf push</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§</p>
<pre><code># ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’å«ã‚€Hostéƒ¨åˆ†ã‚’å–å¾—ã—ã€å¤‰æ•°ã«è¨­å®šã™ã‚‹
HOST=$(cf curl /v2/apps/$(cf app hello-cf --guid)/routes | jq -r &#34;.resources[0].entity.host&#34;)

# Spring Boot Acutatorã®Healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
curl -s https://${HOST}.apps.dev.example.com/actuator/health -w &#39;\n&#39;</code></pre>
<p><br>æ¬¡ã®ã‚ˆã†ã«å‡ºåŠ›ã•ã‚Œã‚Œã°OKã§ã™ã€‚</p>
<pre><code>{&#34;status&#34;:&#34;UP&#34;}</code></pre>
<h2 is-upgraded>Spring Boot Actuatorã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå…¬é–‹</h2>
<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html" target="_blank">Spring Boot Actuator</a>ã«ã¯é‹ç”¨ã«å½¹ç«‹ã¤ä¾¿åˆ©ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¤šæ•°ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯<code>/actuator/info</code>ã¨<code>/actuator/health</code>ã®ã¿å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚<code>manifest.yml</code>ã«æ¬¡ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã€<code>/actuator/env</code>ã¨<code>/actuator/prometheus</code>ã‚‚å…¬é–‹ã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    # â­ï¸â­ï¸â­ï¸
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus</code></pre>
<p><code>cf push</code>ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<pre><code>cf push</code></pre>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code># å…¬é–‹ä¸­ã®Actuatorã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®åˆ—æŒ™
curl -s https://${HOST}.apps.dev.example.com/actuator | jq .

# Envã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
curl -s https://${HOST}.apps.dev.example.com/actuator/env | jq .

# Prometheusã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
curl -s https://${HOST}.apps.dev.example.com/actuator/prometheus</code></pre>
<aside class="special"><p>Note: Envã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†…éƒ¨æƒ…å ±ã‚’å«ã‚€ãŸã‚ã€publicã«å…¬é–‹ã—ãªã„ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚</p>
</aside>
<h2 is-upgraded>Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ´»ç”¨</h2>
<p>Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯<code>info.</code>ã‹ã‚‰å§‹ã¾ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ãŸã¯ã€<code>INFO_</code>ã‹ã‚‰å§‹ã¾ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’JSONå½¢å¼ã§å‡ºåŠ›ã—ã¾ã™ã€‚å‹•ä½œã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©å«ã‚ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚</p>
<p><code>manifest.yml</code>ã«æ¬¡ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    # â­ï¸â­ï¸â­ï¸
    INFO_VERSION: 0.0.1
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}</code></pre>
<p><code>cf push</code>ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<pre><code>cf push</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq .
{
  &#34;java&#34;: {
    &#34;vendor&#34;: &#34;Pivotal Software Inc&#34;,
    &#34;version&#34;: &#34;11.0.6+10&#34;
  },
  &#34;version&#34;: &#34;0.0.1&#34;
}</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ãƒ­ã‚°ã®ç¢ºèª" duration="5">
        <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã¯<code>cf logs</code>ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚<code>--recent</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ç›´è¿‘ã®ãƒ­ã‚°ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>cf logs hello-cf --recent</code></pre>
<p><br>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ãªã„å ´åˆã¯ã€ãƒ­ã‚°ã‚’è¿½è·¡ã—ã¾ã™ã€‚</p>
<pre><code>cf logs hello-cf</code></pre>
<p>å¾Œã»ã©Apps Managerã‚„App Metricsã§ã‚‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚<br></p>
<aside class="special"><p>Note: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®è²¬ä»»ç¯„å›²å†…ã§ã€ã‚¢ãƒ—ãƒªå˜ä½ã§logã‚’å¤–éƒ¨ã®Syslog Serverã«è»¢é€ã—ãŸã„å ´åˆã¯ã€<a href="https://docs.cloudfoundry.org/devguide/services/log-management.html" target="_blank">Syslog Drain</a>ã¨ã„ã†æ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚</p>
<p><a href="https://docs.pivotal.io/platform/application-service/2-8/loggregator/agent-architecture.html" target="_blank">Aggregate Syslog Drain</a>ã¨ã„ã†Platformã®æ©Ÿèƒ½ã‚’ä½¿ã„ã€å…¨ã¦ã®ã‚¢ãƒ—ãƒªãƒ­ã‚°ã‚’Syslog Serverã«è»¢é€ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Apps Managerã®ç¢ºèªãŠã‚ˆã³Spring Boot Actuatoré€£æº" duration="30">
        <p>Apps Manager(<a href="https://apps.sys.dev.example.com" target="_blank">https://apps.sys.dev.example.com</a>)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<p>hol Org &gt; ãƒ¦ãƒ¼ã‚¶ãƒ¼å Space &gt; hello-cfã¨é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/9ee66ffa90cdaf1a.png"></p>
<p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«Spring Boot ActuatorãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Apps Managerã‹ã‚‰Spring Boot Actuatorã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚<img style="width: 29.66px" src="img/c108897736d6085f.png">ãƒãƒ¼ã‚¯ãŒã¤ã„ã¦ã„ã‚Œã°é€£æºã§ãã¦ã„ã¾ã™ã€‚<br><a href="https://docs.pivotal.io/platform/application-service/2-8/console/using-actuators.html" target="_blank">https://docs.pivotal.io/platform/application-service/2-8/console/using-actuators.html</a></p>
<h2 is-upgraded>Healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª</h2>
<p>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æƒ…å ±ã®å·¦ã®&#34; &gt; &#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚Healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æƒ…å ±ãŒè©³ç´°ä»˜ãã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/8211348a2d1074c9.png"></p>
<aside class="special"><p>Note: Healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è©³ç´°ã®è¦‹ã›æ–¹ã¯<code>management.endpoint.health.show-details</code>ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å¤‰æ›´ã§ãã¾ã™ãŒã€publicãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¯è©³ç´°ã‚’è¦‹ã›ãªã„ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚Apps ManagerçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã¯è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
</aside>
<h2 is-upgraded>Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª</h2>
<p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®&#34;Settings&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€&#34;Spring Boot Info&#34;ã®&#34;VIEW RAW JSON&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<code>curl</code>ã§ç¢ºèªã—ãŸæ™‚ã¨åŒã˜æƒ…å ±ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/b5ab63b5db0767cd.png"></p>
<aside class="special"><p>Note: <code>MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE</code>ã‹ã‚‰<code>info</code>ã‚’é™¤å¤–ã—ã¦ã‚‚ã€Apps Managerã‹ã‚‰ã¯Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å†…å®¹ã‚’publicã«ã—ãŸããªã„å ´åˆ<code>ã¯MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLU</code>DEã«<code>info</code>ã‚’å«ã‚ãšã€Apps Managerã‹ã‚‰ã®ã¿ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚</p>
</aside>
<aside class="special"><p>Note: æ¬¡ã®è¨­å®šã‚’è¡Œã„ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«gitã®æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã‚€ã¨Apps Managerä¸Šã«gitã®æƒ…å ±ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<ul>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-application-info-git" target="_blank">https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-application-info-git</a></li>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto-git-info" target="_blank">https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto-git-info</a></li>
</ul>
<p class="image-container"><img style="width: 601.70px" src="img/ae86edcebf66b3ed.png"></p>
<p><a href="https://docs.pivotal.io/platform/application-service/2-8/console/using-actuators.html#view-build" target="_blank">https://docs.pivotal.io/platform/application-service/2-8/console/using-actuators.html#view-build</a></p>
</aside>
<h2 is-upgraded>ThreadDumpã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª</h2>
<p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®&#34;Threads&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ€ãƒ³ãƒ—ã‚’å–å¾—ã§ãã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/4b1fc793c7a400.png"></p>
<h2 is-upgraded>Loggingã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª</h2>
<p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®&#34;Logs&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<code>cf logs --recent</code>ã‚³ãƒãƒ³ãƒ‰ã¨åŒã˜ãç›´è¿‘ã®ãƒ­ã‚°ã‚’ç¢ºèªã§ãã¾ã™ã€‚<img style="width: 25.96px" src="img/5f59a1de02197201.png">ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ­ã‚°ã‚’tailã§ãã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/402cb1ac5055d46d.png"></p>
<p>&#34;CONFIGURE LOGGING LEVEL&#34;ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’å‹•çš„ã«å¤‰æ›´ã™ã‚‹ãŸã‚ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«&#34;DispatcherServlet&#34;ã‚’å…¥åŠ›ã—ã€ãƒ¬ãƒ™ãƒ«ã‚’DEBUGã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/c6f373ec75cab0c4.png"></p>
<p><img style="width: 25.96px" src="img/5f59a1de02197201.png">ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ­ã‚°ã‚’tailã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨DispatcherServletã®DEBUGãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/2deef386203b838c.png"></p>
<p>ã“ã®å¤‰æ›´ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†èµ·å‹•ã•ã‚Œã‚‹ã¾ã§åæ˜ ã•ã‚Œã¾ã™ã€‚ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆã®ãŸã‚ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•ã™ã‚‹ã“ã¨ãªãä¸€æ™‚çš„ã«DEBUGãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãŸã„å ´åˆã«æœ‰ç”¨ã§ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="App Metricsã®ç¢ºèª" duration="15">
        <p>Apps Metricsã‚’ä½¿ç”¨ã™ã‚‹ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚<code>cf logs</code>ã¨ã¯ç•°ãªã‚Šã€ãƒ­ã‚°ã¯æ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚éå»ã®ãƒ­ã‚°ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<p>Apps Managerã®&#34;View in PCF Metrics&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚(ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨æ–‡è¨€ã¯&#34;View in App Metrics&#34;ã«å¤‰ã‚ã‚Šã¾ã™ã€‚) </p>
<h2 is-upgraded><img style="width: 601.70px" src="img/fad97189846b7eb0.png"></h2>
<aside class="warning"><p>Note: Chromeã®æ‹¡å¼µã§ã€AdBlockãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€App Metricsã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ãƒªãƒ³ã‚¯ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚AdBlockã‚’ç„¡åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
</aside>
<p>æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<img style="width: 601.70px" src="img/8d94b023199eb584.png"></p>
<aside class="special"><p>Note: ä¸€è¡Œç›®ã«è¡¨ç¤ºã•ã‚Œã‚‹3ã¤ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯REDãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨å‘¼ã°ã‚Œã€ä¸€èˆ¬çš„ã«è¨ˆæ¸¬ã™ã¹ãæœ€é‡è¦ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã™ã€‚</p>
<ul>
<li><strong>R</strong>ate ... App Metricsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã¸ã®åˆ†é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•° (HTTP Request Count (per minute))</li>
<li><strong>E</strong>rror ... App Metricsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã®åˆ†é–“500ã‚¨ãƒ©ãƒ¼æ•° (HTTP Request Errors)ã€‚500ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ã‚‚å«ã‚ãŸæ–¹ãŒè‰¯ã„ã€‚</li>
<li><strong>D</strong>uration ... App Metricsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã®å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· (HTTP Request Latency in milliseconds)ã€‚95 percentileã¨ã‹ã®æ–¹ãŒè‰¯ã„ã€‚</li>
</ul>
</aside>
<p>&#34;LOGS&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<h2 is-upgraded><img style="width: 601.70px" src="img/4206d614cdbf9373.png"></h2>
<p>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚&#34;App (Application)&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€&#34;ALL&#34;ã¾ãŸã¯&#34;RTR (Router)&#34;ã‚’é¸æŠã—ã€&#34;APPLY&#34;ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/eb9f16c7b05051cf.png"></p>
<p>ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚‚å¸¸ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/b486f5d9b7f0bc11.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãŠã‚ˆã³User Provided Serviceã®ä½¿ã„æ–¹" duration="60">
        <p>ã‚¢ãƒ—ãƒªã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã‚’ã„ãã¤ã‹è¦‹ã¦ã„ãã¾ã™ã€‚</p>
<h2 is-upgraded>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ç’°å¢ƒå¤‰æ•°ã®åŸ‹ã‚è¾¼ã¿</h2>
<p>ã¾ãšã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ç’°å¢ƒå¤‰æ•°ã§å¤‰æ›´å¯èƒ½ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£(<code>api.key</code>)ã‚’ä½œæˆã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
<p>æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚<br></p>
<p><code>src/main/java/com/example/ApiProperties.java</code></p>
<pre><code>package com.example;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@ConfigurationProperties(prefix = &#34;api&#34;)
public class ApiProperties {

    private String key = &#34;SECRET&#34;;

    public String getKey() {
        return key;
    }

    public void setKey(String key) {
        this.key = key;
    }
}</code></pre>
<p><code>src/main/java/com/example/HelloController.java</code></p>
<pre><code>package com.example;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController {

    private final ApiProperties props;

    public HelloController(ApiProperties props) {
        this.props = props;
    }

    @GetMapping(path = &#34;/&#34;)
    public ResponseEntity&lt;?&gt; hello(@RequestHeader(name = &#34;X-Api-Key&#34;, required = false) String apiKey) {
        if (props.getKey().equals(apiKey)) {
            return ResponseEntity.ok(&#34;Hello&#34;);
        } else {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(&#34;Forbidden&#34;);
        }
    }
}</code></pre>
<p><br>ã¾ãšã¯<code>manifest.yml</code>ã«æ¬¡ã®ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°<code>API_KEY</code>ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    INFO_VERSION: 0.0.2 # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    # â­ï¸â­ï¸â­ï¸
    API_KEY: opensesami</code></pre>
<aside class="special"><p>Note: Spring Bootã§ã¯<code>foo.bar-baz</code>ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã™ã‚‹å ´åˆã¯ã€&#34;<code>.</code>&#34;ã‚„&#34;<code>-</code>&#34;ãŒä½¿ãˆãªã„ã®ã§ã€ä»£ã‚ã‚Šã«<code>FOO_BARBAZ</code>ã¨ã„ã†åå‰ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
</aside>
<p><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦å†åº¦<code>cf push</code>ã—ã¾ã™ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true
cf push</code></pre>
<p><br>HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼&#34;<code>X-Api-Key</code>&#34;ãŒ<code>opensesami</code>ã®å ´åˆã®ã¿<code>Hello</code>ãŒè¿”ã‚Šã€ãã‚Œä»¥å¤–ã®å ´åˆã¯<code>Forbidden</code>ãŒè¿”ã‚Šã¾ã™ã€‚</p>
<pre><code>$ curl -sv https://${HOST}.apps.dev.example.com
&gt; GET / HTTP/1.1
&gt; Host: hello-cf-bold-lion-rf.apps.dev.example.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 403 Forbidden
&lt; Content-Length: 9
&lt; Content-Type: text/plain;charset=UTF-8
&lt; Date: Fri, 03 Jul 2020 09:56:57 GMT
&lt; X-Vcap-Request-Id: 91d58464-be27-4101-4e21-24d395def6d4
&lt; 
Forbidden

$ curl -sv -H &#34;X-Api-Key: opensesami&#34; https://${HOST}.apps.dev.example.com
&gt; GET / HTTP/1.1
&gt; Host: hello-cf-bold-lion-rf.apps.dev.example.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; X-Api-Key: opensesami
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Content-Length: 5
&lt; Content-Type: text/plain;charset=UTF-8
&lt; Date: Fri, 03 Jul 2020 09:57:39 GMT
&lt; X-Vcap-Request-Id: 956e9ec3-60c6-494c-4879-dc52f76e1d33
&lt; 
Hello</code></pre>
<h2 is-upgraded>User Provided Serviceã‚’çµŒç”±ã—ã¦ç’°å¢ƒå¤‰æ•°ã®è¨­å®š</h2>
<p><code>manifest.yml</code>ã¯é€šå¸¸gitã§ç®¡ç†ã—ã¾ã™ã€‚gitã§ç®¡ç†ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ç›´æ¥API Keyã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã®ã¯ã‚»ã‚­ãƒ¥ã‚¢ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ‰‹å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã™ã‚‹ä»£ã‚ã‚Šã«Platformå´ã«ä¿å­˜ã—ã¾ã—ã‚‡ã†ã€‚ã¾ãšã¯<a href="https://docs.cloudfoundry.org/devguide/services/user-provided.html" target="_blank">User Provided Service</a>ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§<code>hello</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚<br></p>
<pre><code>cf create-user-provided-service hello -p &#39;{&#34;api-key&#34;:&#34;OPENSESAMI&#34;}&#39;</code></pre>
<p><code>hello</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’<code>hello-cf</code>ã‚¢ãƒ—ãƒªã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã‚ˆã†ã«<code>manifest.yml</code>ã‚’ç·¨é›†ã—ã¾ã™ã€‚ã¾ãŸã€ç’°å¢ƒå¤‰æ•°<code>API_KEY</code>ã®å€¤ã‚’<code>hello</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰<code>api-key</code>ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  # â­ï¸â­ï¸â­ï¸
  services:
  - hello
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    INFO_VERSION: 0.0.2
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    # â­ï¸â­ï¸â­ï¸
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<aside class="special"><p>Note: <code>${vcap.services.&lt;service instance name&gt;.credentials.&lt;key name&gt;}</code>å½¢å¼ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—ã§ãã‚‹ã®ã¯Spring Bootã®æ©Ÿèƒ½ã§ã™ã€‚ãã®ä»–ã®è¨€èªã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ç’°å¢ƒå¤‰æ•°<code>VCAP_SERVICES</code>ã‹ã‚‰JSONæ–‡å­—åˆ—ã‚’å–å¾—ã—ã€ã“ã‚Œã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦å€¤ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä½¿ç”¨ä¾‹ã¯<a href="https://blog.ik.am/entries/529" target="_blank">ã“ã¡ã‚‰</a>ã€‚</p>
<p>ã‚ã‚‹ã„ã¯æœ‰å¿—ã«ã‚ˆã‚‹Pancake Buildpackã‚’ä½¿ã†ã“ã¨ã§ç’°å¢ƒå¤‰æ•°<code>VCAP_SERVICES</code>ã‹ã‚‰JSONæ–‡å­—åˆ—ã‚’flatãªç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ç›´ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<p><a href="https://github.com/starkandwayne/pancake-buildpack" target="_blank">https://github.com/starkandwayne/pancake-buildpack</a></p>
</aside>
<p><code>cf push</code>ã§å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<pre><code>cf push</code></pre>
<p>ä»Šåº¦ã¯HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼&#34;<code>X-Api-Key</code>&#34;ãŒ<code>OPENSESAMI</code>ã®å ´åˆã®ã¿<code>Hello</code>ãŒè¿”ã‚Šã€ãã‚Œä»¥å¤–ã®å ´åˆã¯<code>Forbidden</code>ãŒè¿”ã‚Šã¾ã™ã€‚</p>
<pre><code>$ curl -sv -H &#34;X-Api-Key: opensesami&#34; https://${HOST}.apps.dev.example.com
&gt; GET / HTTP/1.1
&gt; Host: hello-cf-bold-lion-rf.apps.dev.example.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; X-Api-Key: opensesami
&gt; 
&lt; HTTP/1.1 403 Forbidden
&lt; Content-Length: 9
&lt; Content-Type: text/plain;charset=UTF-8
&lt; Date: Fri, 03 Jul 2020 09:56:57 GMT
&lt; X-Vcap-Request-Id: 91d58464-be27-4101-4e21-24d395def6d4
&lt; 
Forbidden

$ curl -sv -H &#34;X-Api-Key: OPENSESAMI&#34; https://${HOST}.apps.dev.example.com
&gt; GET / HTTP/1.1
&gt; Host: hello-cf-bold-lion-rf.apps.dev.example.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; X-Api-Key: OPENSESAMI
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Content-Length: 5
&lt; Content-Type: text/plain;charset=UTF-8
&lt; Date: Fri, 03 Jul 2020 09:57:39 GMT
&lt; X-Vcap-Request-Id: 956e9ec3-60c6-494c-4879-dc52f76e1d33
&lt; 
Hello</code></pre>
<p><br>User Provided Serviceã‚’ä½¿ã†ã“ã¨ã§<code>manifest.yml</code>ã«API Keyã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ãªãã¦ã‚‚æ¸ˆã‚€ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€User Provided Serviceã«æ ¼ç´ã—ãŸæƒ…å ±ã¯æš—å·åŒ–ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€æ©Ÿå¯†æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã¨ã—ã¦ã¯ã‚»ã‚­ãƒ¥ã‚¢ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸæ¬¡ã®ã‚ˆã†ã«<code>cf env</code>ã‚³ãƒãƒ³ãƒ‰ã§è¨­å®šå€¤ã‚’è¦‹ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ãªCredHub Service Brokerã‚’åˆ©ç”¨ã—ã¾ã™ã€‚</p>
<pre><code>$ cf env hello-cf
Getting env variables for app hello-cf in org hol / space tmaki as tmaki@pivotal.io...
OK

System-Provided:
{
 &#34;VCAP_SERVICES&#34;: {
  &#34;user-provided&#34;: [
   {
    &#34;binding_name&#34;: null,
    &#34;credentials&#34;: {
     â­ï¸â­ï¸â­ï¸&#34;api-key&#34;: &#34;OPENSESAMI&#34;
    },
    &#34;instance_name&#34;: &#34;hello&#34;,
    &#34;label&#34;: &#34;user-provided&#34;,
    &#34;name&#34;: &#34;hello&#34;,
    &#34;syslog_drain_url&#34;: &#34;&#34;,
    &#34;tags&#34;: [],
    &#34;volume_mounts&#34;: []
   }
  ]
 }
}
... (ç•¥) ...</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CredHub Service Brokerã‚’ä½¿ã£ã¦æ©Ÿå¯†æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªã‹ã‚‰å‚ç…§" duration="15">
        <p>æ©Ÿå¯†æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã¨ã—ã¦ã¯ã‚»ã‚­ãƒ¥ã‚¢ãªå ´æ‰€ã¨ã—ã¦CredHubãŒé©åˆ‡ã§ã™ã€‚User Provided Serviceã®ä»£ã‚ã‚Šã«<a href="https://docs.pivotal.io/credhub-service-broker/" target="_blank">CredHub Service Broker</a>ã‚’ä½¿ã†ã“ã¨ã§cfã‚³ãƒãƒ³ãƒ‰ã§æ©Ÿå¯†æƒ…å ±ã‚’CredHubã«ç™»éŒ²ã§ãã€ã‹ã¤User Provided Serviceã¨åŒã˜ã‚ˆã†ã«æ‰±ãˆã¾ã™ã€‚</p>
<p>ã¾ãšã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€å…ˆã«ä½œæˆã—ãŸ<code>hello</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’<code>hello-cf</code>ã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¢ãƒ³ãƒã‚¤ãƒ³ãƒ‰ã—ã€<code>hello</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
<pre><code>cf unbind-service hello-cf hello
cf delete-service -f hello</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Credhub ServiceãŒMarketplaceã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf marketplace
Getting services from marketplace in org hol / space tmaki as tmaki@pivotal.io...
OK

service          plans      description                                                                    broker

app-autoscaler   standard   Scales bound applications in response to load                                  app-autoscaler
smb              Existing   Existing SMB shares (see: https://code.cloudfoundry.org/smb-volume-release/)   smbbroker
â­ï¸â­ï¸â­ï¸credhub          default    Stores configuration parameters securely in CredHub                            credhub-broker
elephantsql      turtle     PostgreSQL as a Service                                                        elephantsql

TIP: Use &#39;cf marketplace -s SERVICE&#39; to view descriptions of individual plans of a given service.</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§CredHub Serviceã®Planã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre><code>$ cf marketplace -s credhub
Getting service plan information for service credhub as tmaki@pivotal.io...
OK

service plan   description                                           free or paid
default        Stores configuration parameters securely in CredHub   free</code></pre>
<p><br><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§<code>hello</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<pre><code>cf create-service credhub default hello -c &#39;{&#34;api-key&#34;: &#34;OpenSesami&#34;}&#39;</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼†ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã¾ãŸã¯å†pushã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>cf bind-service hello-cf hello
cf restart hello-cf

# ã¾ãŸã¯

cf push</code></pre>
<p><br>User Provided Serviceã®å ´åˆã¨åŒã˜ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ curl -sv -H &#34;X-Api-Key: opensesami&#34; https://${HOST}.apps.dev.example.com
&gt; GET / HTTP/1.1
&gt; Host: hello-cf-bold-lion-rf.apps.dev.example.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; X-Api-Key: opensesami
&gt; 
&lt; HTTP/1.1 403 Forbidden
&lt; Content-Length: 9
&lt; Content-Type: text/plain;charset=UTF-8
&lt; Date: Fri, 03 Jul 2020 09:56:57 GMT
&lt; X-Vcap-Request-Id: 91d58464-be27-4101-4e21-24d395def6d4
&lt; 
Forbidden

$ curl -sv -H &#34;X-Api-Key: OPENSESAMI&#34; https://${HOST}.apps.dev.example.com
&gt; GET / HTTP/1.1
&gt; Host: hello-cf-bold-lion-rf.apps.dev.example.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; X-Api-Key: OPENSESAMI
&gt; 
&lt; HTTP/1.1 403 Forbidden
&lt; Content-Length: 9
&lt; Content-Type: text/plain;charset=UTF-8
&lt; Date: Wed, 22 Jul 2020 14:58:44 GMT
&lt; X-Vcap-Request-Id: 6561440e-2f31-4199-7f0c-b39c10c64a51
&lt; 
Forbidden


$ curl -sv -H &#34;X-Api-Key: OpenSesami&#34; https://${HOST}.apps.dev.example.com
&gt; GET / HTTP/1.1
&gt; Host: hello-cf-bold-lion-rf.apps.dev.example.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; X-Api-Key: OpenSesami
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Content-Length: 5
&lt; Content-Type: text/plain;charset=UTF-8
&lt; Date: Fri, 03 Jul 2020 09:57:39 GMT
&lt; X-Vcap-Request-Id: 956e9ec3-60c6-494c-4879-dc52f76e1d33
&lt; 
Hello</code></pre>
<p><code>cf env</code>ã‚’å®Ÿè¡Œã—ã¦ã‚‚API Keyã®å€¤ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf env hello-cf
Getting env variables for app hello-cf in org hol / space tmaki as tmaki@pivotal.io...
OK

System-Provided:
{
 &#34;VCAP_SERVICES&#34;: {
  &#34;credhub&#34;: [
   {
    &#34;binding_name&#34;: null,
    &#34;credentials&#34;: {
     â­ï¸â­ï¸â­ï¸&#34;credhub-ref&#34;: &#34;/credhub-service-broker/credhub/c7b80368-3e4c-4ede-9b03-b26eafb30db9/credentials&#34; 
    },
    &#34;instance_name&#34;: &#34;hello&#34;,
    &#34;label&#34;: &#34;credhub&#34;,
    &#34;name&#34;: &#34;hello&#34;,
    &#34;plan&#34;: &#34;default&#34;,
    &#34;provider&#34;: null,
    &#34;syslog_drain_url&#34;: null,
    &#34;tags&#34;: [
     &#34;credhub&#34;
    ],
    &#34;volume_mounts&#34;: []
   }
  ]
 }
}
... (ç•¥) ...</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ" duration="75">
        <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚<code>cf push</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå ´åˆã¯æ—§ç‰ˆã®Stop -&gt; æ–°ç‰ˆã®Startã¨ã„ã†Stepã«ãªã‚Šã¾ã™ã€‚ã“ã®é–“ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“(404ã‚¨ãƒ©ãƒ¼)ã€‚Tanzu Application Serviceã§ã¯ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚’èµ·ã“ã•ãšã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€</p>
<ul>
<li>Blue-Green Update</li>
<li>Rolling Update</li>
</ul>
<p>ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚</p>
<h2 is-upgraded>Blue-Green Update</h2>
<p>Blue-Green Updateã¯æ—§ç‰ˆã¨æ–°ç‰ˆã‚’åŒå±…ã—ãŸçŠ¶æ…‹ã§ä¸¡æ–¹ã®ã‚¢ãƒ—ãƒªã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã€æ–°ç‰ˆã§ã‚‚å•é¡Œãªãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã®ã¡ã«ã€æ—§ç‰ˆã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ãªãŒã‚‰å¾ã€…ã«æ–°ç‰ˆã«ç§»è¡Œã§ãã‚‹ç‚¹ã¨ã€æ–°ç‰ˆã«å•é¡ŒãŒã‚ã‚‹å ´åˆã¯æ—§ç‰ˆã«åˆ‡ã‚Šæˆ»ã—ã‚„ã™ã„ç‚¹ãŒç‰¹å¾´ã§ã™ã€‚Blue-Green Updateã§ã¯æ—§ç‰ˆã¨æ–°ç‰ˆã¯åˆ¥ã®ç‹¬ç«‹ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚Tanzu Application Serviceã§ã¯æ—§ç‰ˆã¨æ–°ç‰ˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯”ç‡ã¯ãã‚Œãã‚Œã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã«æ¯”ä¾‹ã—ã¾ã™ã€‚æ—§ç‰ˆã¨æ–°ç‰ˆã‚’åŒå±…ã•ã›ã‚‹å ´åˆã€é€šå¸¸ã¯ä½™å‰°ãªãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚</p>
<p><a href="https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html" target="_blank">https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html</a></p>
<p>ç¾åœ¨ç¨¼åƒä¸­ã®<code>hello-cf</code>ã‚¢ãƒ—ãƒªã‚’Blueã¨ã—ã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 600.00px" src="img/e7495e8cffd6e8ad.png"></p>
<p>Blueã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’Spring Boot Actuatorã®Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ç¢ºèªã—ã¾ã™ã€‚<br></p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.2</code></pre>
<p>æ¬¡ã«æ–°ç‰ˆ(Green)ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ã›ãšã€ç’°å¢ƒå¤‰æ•°<code>INFO_VERSION</code>ã®ã¿å¤‰æ›´ã—ã¾ã™ã€‚<br><code>manifest.yml</code>ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    INFO_VERSION: 0.0.3 # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<p><br>ã“ã®<code>manifest.yml</code>ã‚’ä½¿ã„ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ¥åã§pushã—ã¾ã™ã€‚</p>
<pre><code>cf push hello-cf-green</code></pre>
<p><code>cf apps</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤ºã—ã€äºŒã¤ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç¨¼åƒã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf apps
Getting apps in org hol / space tmaki as tmaki@pivotal.io...
OK

name             requested state   instances   memory   disk   urls
hello-cf         started           1/1         768M     1G     hello-cf-bold-lion-rf.apps.dev.example.com
hello-cf-green   started           1/1         768M     1G     hello-cf-green-hilarious-rabbit-nz.apps.dev.example.com</code></pre>
<p><br>æ¬¡ã®å›³ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 600.00px" src="img/81ca53f831b20a35.png"></p>
<p><code>hello-cf-green</code>ã‚¢ãƒ—ãƒªã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ©ãƒ³ãƒ€ãƒ ãªHostéƒ¨ã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å–å¾—ã—ã¾ã™ã€‚</p>
<pre><code>HOST_NEW=$(cf curl /v2/apps/$(cf app hello-cf-green --guid)/routes | jq -r &#34;.resources[0].entity.host&#34;)</code></pre>
<p>Greenã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’Spring Boot Actuatorã®Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ç¢ºèªã—ã¾ã™ã€‚<br></p>
<pre><code>$ curl -s https://${HOST_NEW}.apps.dev.example.com/actuator/info | jq -r .version
0.0.3</code></pre>
<p>ã“ã®æ®µéšã§ã¯Blueã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ãŒãªã„ã“ã¨ã‚‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.2</code></pre>
<p><br>ç¾æ™‚ç‚¹ã§ã¯Blueã¨Greenã¯å…¨ãåˆ¥ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ãã‚Œãã‚Œå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚Greenã®URLã¯ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯çŸ¥ã‚‰ã‚Œã¦ã„ãªã„ãŸã‚ã€å®‰å…¨ã«ãƒ†ã‚¹ãƒˆå¯èƒ½ã§ã™ã€‚</p>
<p>æ¬¡ã«ã€æ¬¡ã®å›³ã®ã‚ˆã†ã«Blueã«å¯¾ã™ã‚‹ãƒ«ãƒ¼ãƒˆã¤ã¾ã‚Šã€ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨ã™ã‚‹URLã‚’Greenã«ã‚‚ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚ã“ã‚Œã§ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Blueã‹Greenã©ã¡ã‚‰ã‹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 600.00px" src="img/9823f83da602742b.png"></p>
<p>æ¬¡ã®<code>cf map-route</code>ã‚³ãƒãƒ³ãƒ‰ã§<code>hello-cf-green</code>ã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦<code>hello-cf</code>ã¨åŒã˜ãƒ«ãƒ¼ãƒˆã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚</p>
<pre><code>$ cf map-route hello-cf-green apps.dev.example.com -n ${HOST}
Creating route hello-cf-bold-lion-rf.apps.dev.example.com for org hol / space tmaki as tmaki@pivotal.io...
OK
Route hello-cf-bold-lion-rf.apps.dev.example.com already exists
Adding route hello-cf-bold-lion-rf.apps.dev.example.com to app hello-cf-green in org hol / space tmaki as tmaki@pivotal.io...
OK</code></pre>
<p><code>cf apps</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤ºã—ã€<code>hello-cf-green</code>ã‚¢ãƒ—ãƒªã«ã¯äºŒã¤ã®ãƒ«ãƒ¼ãƒˆãŒãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf apps
Getting apps in org hol / space tmaki as tmaki@pivotal.io...
OK

name             requested state   instances   memory   disk   urls
hello-cf         started           1/1         768M     1G     hello-cf-bold-lion-rf.apps.dev.example.com
hello-cf-green   started           1/1         768M     1G     hello-cf-bold-lion-rf.apps.dev.example.com, hello-cf-green-hilarious-rabbit-nz.apps.dev.example.com</code></pre>
<p><br>å…ƒã€…Blueã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ãŸURLã«ä½•åº¦ã‹ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚æ–°æ—§ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒRound-Robinã§è¿”ã‚Šã¾ã™ã€‚</p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.2
$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.3
$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.2
$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.3</code></pre>
<p>æ¬¡ã«ã€æ¬¡ã®å›³ã®ã‚ˆã†ã«Blueã¸ã®Routeã‚’å‰Šé™¤ã—ã€ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGreenã«ã—ã‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚<br><img style="width: 600.00px" src="img/4cb52df0d97e79dd.png"></p>
<p>æ¬¡ã®<code>cf unmap-route</code>ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€<code>hello-cf</code>ã‚¢ãƒ—ãƒªã‹ã‚‰å…ƒã®ãƒ«ãƒ¼ãƒˆã‚’ã‚¢ãƒ³ãƒãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf unmap-route hello-cf apps.dev.example.com -n ${HOST}
Removing route hello-cf-bold-lion-rf.apps.dev.example.com from app hello-cf in org hol / space tmaki as tmaki@pivotal.io...
OK</code></pre>
<p><code>cf apps</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤ºã—ã€<code>hello-cf</code>ã‚¢ãƒ—ãƒªã«ã¯ãƒ«ãƒ¼ãƒˆãŒãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf apps
Getting apps in org hol / space tmaki as tmaki@pivotal.io...
OK

name             requested state   instances   memory   disk   urls
hello-cf         started           1/1         768M     1G
hello-cf-green   started           1/1         768M     1G     hello-cf-bold-lion-rf.apps.dev.example.com, hello-cf-green-hilarious-rabbit-nz.apps.dev.example.com</code></pre>
<p><br>å…ƒã€…Blueã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ãŸURLã«ä½•åº¦ã‹ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚å…¨ã¦æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¿”ã‚Šã¾ã™ã€‚</p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.3
$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.3
$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.3
$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.3</code></pre>
<p><br>ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®100%ãŒGreenã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã‚‚å•é¡Œãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€Blueã¯åœæ­¢ã¾ãŸã¯å‰Šé™¤ã—ã¾ã™ã€‚ç´ æ—©ã„åˆ‡ã‚Šæˆ»ã—[1]ã‚’ã—ãŸã„å ´åˆã¯åœæ­¢ã«ã—ã¦ãã ã•ã„ã€‚ã¾ãŸGreenã«ãƒãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã¯ä¸è¦ãªã®ã§å‰Šé™¤ã—ã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 600.00px" src="img/d394a3cf23860bb.png"></p>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
<pre><code># éå»ã®BlueãŒã„ãŸã‚‰å‰Šé™¤
cf delete -f hello-cf-blue

# åˆ‡ã‚Šæˆ»ã—ã§ãã‚‹ã‚ˆã†ã«hello-cfã‚’hello-cf-blueã«ãƒªãƒãƒ¼ãƒ 
cf rename hello-cf hello-cf-blue 

# hello-cf-greenã‚’hello-cfã«æ˜‡æ ¼
cf rename hello-cf-green hello-cf

# hello-cf-blueã‚’Delete(ã¾ãŸã¯Stop)
cf delete -f hello-cf-blue

# Greenã«ãƒãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã¯ã‚¢ãƒ³ãƒãƒƒãƒ—
cf unmap-route hello-cf apps.dev.example.com -n ${HOST_NEW}

# ã‚¢ãƒ³ãƒãƒƒãƒ—ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤
cf delete-route apps.dev.example.com -n ${HOST_NEW} -f</code></pre>
<p><code>cf apps</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤ºã—ã€<code>hello-cf</code>ã‚¢ãƒ—ãƒªã«ã¯å…ƒã€…ã®ãƒ«ãƒ¼ãƒˆãŒãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚è¡¨ç¤ºæ™‚ä¸Šã¯Greenã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã¨åŒã˜ã§ã™ã€‚</p>
<pre><code>$ cf apps
Getting apps in org hol / space tmaki as tmaki@pivotal.io...
OK

name            requested state   instances   memory   disk   urls
hello-cf        started           1/1         768M     1G     hello-cf-bold-lion-rf.apps.dev.example.com</code></pre>
<aside class="special"><p>Note: ä¸Šè¨˜ã®æ‰‹é †ã¯<a href="https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html" target="_blank">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>ã«è¨˜è¼‰ã•ã‚ŒãŸé€šã‚Šã®ã‚„ã‚Šæ–¹ã§ã™ãŒã€æ¬¡ã®æ‰‹é †ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹ãŒStepãŒå°‘ãªãæ¸ˆã¿ã¾ã™ã€‚</p>
<ol type="1" start="1">
<li>æ—§ã‚¢ãƒ—ãƒªã®åå‰ã‚’renameã€‚ã“ã“ã§ã¯suffixã«&#34;<code>-venerable</code>&#34;ã‚’ã¤ã‘ã‚‹ã€‚<br><code>cf rename hello-cf hello-cf-venerable</code></li>
<li>æ–°ã‚¢ãƒ—ãƒªã‚’æ—§ã‚¢ãƒ—ãƒªã®ã®å…ƒã®åå‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤<br><code>cf push</code></li>
<li>æ–°ã‚¢ãƒ—ãƒªã«å…ƒã®Routeã‚’ãƒãƒƒãƒ”ãƒ³ã‚° (<code>random-route: true</code>ã®å ´åˆã®ã¿)<br><code>cf map-route hello-cf apps.dev.example.com -n ${HOST}</code> </li>
<li>æ—§ã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã¾ãŸã¯åœæ­¢<br><code>cf delete -f hello-cf-venerable</code></li>
</ol>
</aside>
<h2 is-upgraded>Rolling Update</h2>
<p>CF CLI v7ã‹ã‚‰ã€Rolling UpdateãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚Blue-Green Updateã¨ã¯ç•°ãªã‚Šã€æ—§ç‰ˆã‹ã‚‰æ–°ç‰ˆã¸ä¸€æ°—ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã™ã€‚ãŸã ã—è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãšã¤é †æ¬¡ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¦ã„ãã®ã§ã€ä½™å‰°ãªãƒªã‚½ãƒ¼ã‚¹ã¯1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã ã‘ã§ã™ã€‚<br><br>ã¾ãšã¯<code>cf scale</code>ã‚³ãƒãƒ³ãƒ‰ã§<code>hello-cf</code>ã‚¢ãƒ—ãƒªã‚’3ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚</p>
<pre><code>cf scale hello-cf -i 3</code></pre>
<p><br>æ¬¡ã«æ–°ç‰ˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ã“ã“ã§ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ã›ãšã€ç’°å¢ƒå¤‰æ•°<code>INFO_VERSION</code>ã®ã¿å¤‰æ›´ã—ã¾ã™ã€‚<br><code>manifest.yml</code>ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 3 # â­ï¸
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    INFO_VERSION: 0.0.4 # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<p><br>ã“ã“ã‹ã‚‰<code>cf7</code>ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<code>cf7</code>ã‚³ãƒãƒ³ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf7 version                                        
cf7 version 7.0.1+fb3f929c2.2020-06-24</code></pre>
<p><br>cf7ã‚³ãƒãƒ³ãƒ‰ã§å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>cf7 login -a api.sys.dev.example.com -o hol --sso</code></pre>
<p><code>cf7 push</code>ã‚³ãƒãƒ³ãƒ‰ã§Rolling Updateã‚’è¡Œã†ãŸã‚ã«<code>--strategy rolling</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚</p>
<pre><code>cf7 push --strategy rolling</code></pre>
<p><br>åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãŠãã¨ã€é †æ¬¡ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¦ã„ãæ§˜å­ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>watch cf7 app hello-cf

# ã¾ãŸã¯

while true;do cf7 app hello-cf;sleep 1;done</code></pre>
<p><br>Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¨¼åƒã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.4</code></pre>
<p><br>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Restartã‚‚Rolling Updateã§å®Ÿæ–½ã§ãã¾ã™ã€‚</p>
<pre><code>cf7 restart --strategy rolling hello-cf</code></pre>
<p><code>manifest.yml</code>ã®å¤‰æ›´ã‚’åæ˜ ã—ãŸã„ã ã‘ã§ã‚ã‚Œã°<code>cf7 push</code>ã‚’å®Ÿè¡Œã—ãªãã¦ã‚‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§é©ç”¨ã§ãã¾ã™ã€‚(<code>cf7 push</code>ã‚ˆã‚Šã‚‚é€Ÿã„ã§ã™ã€‚)<br></p>
<pre><code>cf7 apply-manifest
cf7 restart --strategy rolling hello-cf</code></pre>
<aside class="warning"><p>Note: Tanzu Application Service (Pivotal Application Service) 2.8ã§ã¯ã€cf7 CLIã®ã„ãã¤ã‹ã®ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
<ul>
<li><code>cf7 apps</code></li>
<li><code>cf7 marketplace</code></li>
<li><code>cf7 login</code> (cf CLI 7.0.2ã®å ´åˆ)</li>
</ul>
<p>ãªã©ã€‚</p>
<p>2.10ã§<code>cf7</code>ãŒæ­£å¼ã«åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
</aside>
<h2 is-upgraded><br><br>Revision</h2>
<p>Blue-Green Updateã«ã‚ˆã£ã¦æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸åˆ‡ã‚Šæˆ»ã—ãŒã§ãã‚‹ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸãŒã€Tanzu Application Serviceã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯<a href="https://docs.cloudfoundry.org/devguide/revisions.html" target="_blank">Revision</a>ã¨ã„ã†ä»•çµ„ã¿ãŒç”¨æ„ã•ã‚Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æƒ…å ±ã‚’ä¸–ä»£ç®¡ç†ã§ãã¾ã™ã€‚Revisionã®ä»•çµ„ã¿ã‚’ä½¿ã£ã¦ç°¡å˜ã«æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸åˆ‡ã‚Šæˆ»ã™(Rollback)ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>Tanzu Application Service (Pivotal Application Service) 2.8ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®RevisionãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚Revisionã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯Apps Managerã®å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®&#34;Revisions&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€&#34;ENABE REVISIONS&#34;ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/2d815fbea5e3b283.png"></p>
<aside class="special"><p>Note: Tanzu Application Service 2.9ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§RevisionãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
</aside>
<p>ã“ã®ãƒšãƒ¼ã‚¸ã«Revisionä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€æœ‰åŠ¹åŒ–ç›´å¾Œã¯ä½•ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</p>
<p><img style="width: 601.70px" src="img/bb80d073eb4e269c.png"><br>Revisionã®æœ‰åŠ¹åŒ–ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚‚è¡Œãˆã¾ã™ã€‚</p>
<pre><code>cf7 curl /v3/apps/$(cf7 app hello-cf --guid)/features/revisions -X PATCH -d &#34;{\&#34;enabled\&#34;: true}&#34;</code></pre>
<p>æœ€åˆã®Revisionã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€<code>cf7 push</code>ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>cf7 push</code></pre>
<p><br>Apps Managerã§Revisionsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚Revision 1ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚Revisionã«ç´ã¥ãç’°å¢ƒå¤‰æ•°ã‚’è¦‹ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚<img style="width: 601.70px" src="img/af564bbdfde2a34f.png"></p>
<p>æ¬¡ã«ç’°å¢ƒå¤‰æ•°<code>INFO_VERSION</code>ã‚’å¤‰æ›´ã—ã¾ã™ã€‚<code>manifest.yml</code>ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 3
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    INFO_VERSION: 0.0.4+r # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<p><code>cf7 push</code>ã§Rolling Updateã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>cf7 push --strategy rolling</code></pre>
<p><br>Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¨¼åƒã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.4+r</code></pre>
<p><br>Apps Managerä¸Šã§Revision 2ãŒä½œæˆã•ã‚Œã€æ–°ã—ã„ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br><br><img style="width: 601.70px" src="img/eb1e906ef726f556.png"></p>
<p><br>æ¬¡ã«ã€Revision 1ã‚’é–‹ãã€&#34;REDEPLOY&#34;ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<br><img style="width: 601.70px" src="img/67822fb4133ea86c.png"><br><br>Revision 1ã«Rollbackã—ã¦ã„ã¾ã™ã€‚Rollbackå¾Œã¯æ–°ãŸã«Revision 3ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚<br><br><img style="width: 601.70px" src="img/224587ed16d13653.png"></p>
<p>Revision 3ãŒRevision 1ã¨åŒã˜ç’°å¢ƒå¤‰æ•°ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br><img style="width: 601.70px" src="img/c55faf8c0905423b.png"><br></p>
<p>Infoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒRollbackã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/actuator/info | jq -r .version
0.0.4</code></pre>
<h2 is-upgraded><br></h2>


      </google-codelab-step>
    
      <google-codelab-step label="Service Brokerã§PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã—ã¦ã‚¢ã‚¯ã‚»ã‚¹" duration="90">
        <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è‡ªå‹•ã§æ‰•ã„å‡ºã™ãŸã‚ã«Service Brokerã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>Hands-on Labç”¨ã®ç’°å¢ƒã«ã¯PostgreSQL as a Serviceã§ã‚ã‚‹<a href="https://www.elephantsql.com" target="_blank">ElaphantSQL</a>ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ãã‚Œã‚‹<a href="https://github.com/making/elephantsql-service-broker" target="_blank">Elephant SQL Service Broker</a>[2]ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§<code>cf</code>ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§å°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã¾ã™ã€‚</p>
<h2 is-upgraded><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´</h2>
<p>ã¾ãšã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ã¦PostgreSQLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚hello-cfãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã®<code>pom.xml</code>ã®<code>&lt;dependencies&gt;</code>å†…ã«æ¬¡ã®3ã¤ã®<code>&lt;deppendency&gt;</code>ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.flywaydb&lt;/groupId&gt;
      &lt;artifactId&gt;flyway-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
      &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
      &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;</code></pre>
<p><code>src/main/java/com/example/CarController.java</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>package com.example;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

import java.sql.PreparedStatement;
import java.util.List;

@RestController
public class CarController {

    private final JdbcTemplate jdbcTemplate;

    public CarController(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @GetMapping(path = &#34;/cars&#34;)
    public ResponseEntity&lt;?&gt; getCars() {
        final List&lt;Car&gt; cars = this.jdbcTemplate.query(&#34;SELECT id, name FROM car ORDER BY id&#34;, (rs, i) -&gt; new Car(rs.getInt(&#34;id&#34;), rs.getString(&#34;name&#34;)));
        return ResponseEntity.ok(cars);
    }

    @PostMapping(path = &#34;/cars&#34;)
    public ResponseEntity&lt;?&gt; postCars(@RequestBody Car car) {
        KeyHolder keyHolder = new GeneratedKeyHolder();
        this.jdbcTemplate.update(connection -&gt; {
            final PreparedStatement statement = connection.prepareStatement(&#34;INSERT INTO car(name) VALUES (?)&#34;, new String[]{&#34;id&#34;});
            statement.setString(1, car.getName());
            return statement;
        }, keyHolder);
        car.setId(keyHolder.getKey().intValue());
        return ResponseEntity.status(HttpStatus.CREATED).body(car);
    }

    @DeleteMapping(path = &#34;/cars/{id}&#34;)
    public ResponseEntity&lt;?&gt; deleteCar(@PathVariable(&#34;id&#34;) Integer id) {
        this.jdbcTemplate.update(&#34;DELETE FROM car WHERE id = ?&#34;, id);
        return ResponseEntity.noContent().build();
    }

    static class Car {

        public Car(Integer id, String name) {
            this.id = id;
            this.name = name;
        }

        private Integer id;

        private String name;

        public Integer getId() {
            return id;
        }

        public void setId(Integer id) {
            this.id = id;
        }

        public String getName() {
            return name;
        }

        public void setName(String name) {
            this.name = name;
        }
    }
}</code></pre>
<p><code>src/main/resources/db/migration/V1__init.sql</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ãªãŠã€<code>src/main/resources/db/migration</code>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯å­˜åœ¨ã—ã¦ã„ãªã„ã®ã§ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>CREATE TABLE car (
    id   SERIAL PRIMARY KEY,
    name VARCHAR(16)
);

INSERT INTO car(name) VALUES (&#39;Avalon&#39;);
INSERT INTO car(name) VALUES (&#39;Corolla&#39;);
INSERT INTO car(name) VALUES (&#39;Crown&#39;);
INSERT INTO car(name) VALUES (&#39;Levin&#39;);
INSERT INTO car(name) VALUES (&#39;Yaris&#39;);
INSERT INTO car(name) VALUES (&#39;Vios&#39;);
INSERT INTO car(name) VALUES (&#39;Glanza&#39;);
INSERT INTO car(name) VALUES (&#39;Aygo&#39;);</code></pre>
<p><code>src/main/resources/application.properties</code>ã«æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>spring.datasource.driver-class-name=org.postgresql.Driver
# Localç”¨ã®ãƒ€ãƒŸãƒ¼è¨­å®š
spring.datasource.url=jdbc:postgresql://localhost:5432/car
spring.datasource.username=${USER}
spring.datasource.password=</code></pre>
<p><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true</code></pre>
<h2 is-upgraded>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ</h2>
<p>Service Brokerã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å˜ä½ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã„ã„ã¾ã™ã€‚<code>cf create-service</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã§ãã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ElephantSQLã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>cf7 create-service elephantsql turtle car-db</code></pre>
<h2 is-upgraded>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤</h2>
<p><code>manifest.yml</code>ã®<code>services</code>ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’æŒ‡å®šã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ã€‚<code>manifest.yml</code>ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1 # â­ï¸
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  - car-db # â­ï¸
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    INFO_VERSION: 0.0.5 # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<p><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’pushã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>cf7 push --strategy rolling</code></pre>
<p><code>hello-cf</code>ã‚¢ãƒ—ãƒªã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯Apps Managerã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®&#34;Services&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p><img style="width: 601.70px" src="img/57f13d3ab3ce055f.png"><br><br>ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚</p>
<pre><code>$ curl -s https://${HOST}.apps.dev.example.com/cars | jq .
[
  {
    &#34;id&#34;: 1,
    &#34;name&#34;: &#34;Avalon&#34;
  },
  {
    &#34;id&#34;: 2,
    &#34;name&#34;: &#34;Corolla&#34;
  },
  {
    &#34;id&#34;: 3,
    &#34;name&#34;: &#34;Crown&#34;
  },
  {
    &#34;id&#34;: 4,
    &#34;name&#34;: &#34;Levin&#34;
  },
  {
    &#34;id&#34;: 5,
    &#34;name&#34;: &#34;Yaris&#34;
  },
  {
    &#34;id&#34;: 6,
    &#34;name&#34;: &#34;Vios&#34;
  },
  {
    &#34;id&#34;: 7,
    &#34;name&#34;: &#34;Glanza&#34;
  },
  {
    &#34;id&#34;: 8,
    &#34;name&#34;: &#34;Aygo&#34;
  }
]

$ curl -s https://${HOST}.apps.dev.example.com/cars -d &#34;{\&#34;name\&#34;: \&#34;Lexus\&#34;}&#34; -H &#34;Content-Type: application/json&#34; | jq .
{
  &#34;id&#34;: 9,
  &#34;name&#34;: &#34;Lexus&#34;
}

$ curl -s https://${HOST}.apps.dev.example.com/cars | jq .
[
  {
    &#34;id&#34;: 1,
    &#34;name&#34;: &#34;Avalon&#34;
  },
  {
    &#34;id&#34;: 2,
    &#34;name&#34;: &#34;Corolla&#34;
  },
  {
    &#34;id&#34;: 3,
    &#34;name&#34;: &#34;Crown&#34;
  },
  {
    &#34;id&#34;: 4,
    &#34;name&#34;: &#34;Levin&#34;
  },
  {
    &#34;id&#34;: 5,
    &#34;name&#34;: &#34;Yaris&#34;
  },
  {
    &#34;id&#34;: 6,
    &#34;name&#34;: &#34;Vios&#34;
  },
  {
    &#34;id&#34;: 7,
    &#34;name&#34;: &#34;Glanza&#34;
  },
  {
    &#34;id&#34;: 8,
    &#34;name&#34;: &#34;Aygo&#34;
  },
  {
    &#34;id&#34;: 9,
    &#34;name&#34;: &#34;Lexus&#34;
  }
]</code></pre>
<p><code>cf env</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¥ç¶šæƒ…å ±ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
<pre><code>$ cf7 env hello-cf
Getting env variables for app hello-cf in org hol / space tmaki as tmaki@pivotal.io...
System-Provided:
VCAP_SERVICES: {
... (ç•¥) ...
 &#34;elephantsql&#34;: [
  {
   &#34;binding_name&#34;: null,
   &#34;credentials&#34;: {
    &#34;hostname&#34;: &#34;satao.db.elephantsql.com&#34;,
    &#34;jdbcUrl&#34;: &#34;jdbc:postgresql://satao.db.elephantsql.com:5432/fxwhicct?user=fxwhicct\u0026password=ahgpepaephpoahpeoaf00gahphapefa&#34;,
    &#34;name&#34;: &#34;fxwhicct&#34;,
    &#34;password&#34;: &#34;ahgpepaephpoahpeoaf00gahphapefa&#34;,
    &#34;port&#34;: 5432,
    &#34;uri&#34;: &#34;postgres://fxwhicct:ahgpepaephpoahpeoaf00gahphapefa@satao.db.elephantsql.com:5432/fxwhicct&#34;,
    &#34;username&#34;: &#34;fxwhicct&#34;
   },
   &#34;instance_name&#34;: &#34;car-db&#34;,
   &#34;label&#34;: &#34;elephantsql&#34;,
   &#34;name&#34;: &#34;car-db&#34;,
   &#34;plan&#34;: &#34;turtle&#34;,
   &#34;provider&#34;: null,
   &#34;syslog_drain_url&#34;: null,
   &#34;tags&#34;: [
    &#34;postgresql&#34;,
    &#34;postgres&#34;,
    &#34;elephantsql&#34;
   ],
   &#34;volume_mounts&#34;: []
  }
 ]
}
... (ç•¥) ...</code></pre>
<p><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã“ã®æ¥ç¶šæƒ…å ±ã‚’ä½¿ã†ã®ãŸã‚ã®ç‰¹åˆ¥ãªè¨­å®šã¯è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚<code>cf push</code>ã®éš›ã«<strong>Java Buildpackã«ã‚ˆã‚Š</strong><a href="https://github.com/cloudfoundry/java-buildpack-auto-reconfiguration" target="_blank"><strong>Auto-Reconfiguation</strong></a><strong>ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè‡ªå‹•ã§è¿½åŠ ã•ã‚Œ</strong>ã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹æ¥ç¶šæƒ…å ±ã‹ã‚‰Javaãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®<strong><code>DataSource</code></strong><strong>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è‡ªå‹•ã§ä½œæˆã—ã¾ã™</strong>ã€‚ãã®ãŸã‚ã€è¨­å®šã—ãªã„ãã¦ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶šã§ãã‚‹ã†ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<p><code>cf logs</code>ã‚³ãƒãƒ³ãƒ‰ã§æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf7 logs hello-cf --recent
...
   2020-07-23T17:14:28.27+0900 [APP/PROC/WEB/0] OUT 2020-07-23 08:14:28.272  INFO 13 --- [           main] o.c.reconfiguration.CloudServiceUtils    : &#39;dataSource&#39; bean of type with &#39;javax.sql.DataSource&#39; reconfigured with &#39;car-db&#39; bean
...</code></pre>
<p><code>car-db</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æƒ…å ±ã‹ã‚‰<code>DataSource</code>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ãŸã“ã¨ã‚’çŸ¥ã‚‰ã›ã¦ã„ã¾ã™ã€‚</p>
<p>ã¾ãŸã€<code>cf push</code>æ™‚ã®ãƒ­ã‚°ã«Auto ReconfigurationãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>$ cf7 push --strategy rolling
Pushing app hello-cf to org hol / space tmaki as tmaki@pivotal.io...
Applying manifest file /Users/toshiaki/hol/hello-cf/manifest.yml...
Manifest applied
Packaging files to upload...
Uploading files...
 391.84 KiB / 391.84 KiB [==========================================================================================================] 100.00% 1s

Waiting for API to complete processing files...

Staging app and tracing logs...
   Downloading java_buildpack_offline...
   Downloaded java_buildpack_offline
   Cell 116dd279-04a8-42e6-96cf-493e727bc0bd creating container for instance d45d87fc-f3dc-418c-a1de-460ff6ebb74b
   Cell 116dd279-04a8-42e6-96cf-493e727bc0bd successfully created container for instance d45d87fc-f3dc-418c-a1de-460ff6ebb74b
   Downloading app package...
   Downloading build artifacts cache...
   Downloaded build artifacts cache (129B)
   Downloaded app package (15.8M)
   -----&gt; Java Buildpack v4.29.1 (offline) | https://github.com/cloudfoundry/java-buildpack.git#864477c
   -----&gt; Downloading Jvmkill Agent 1.16.0_RELEASE from https://java-buildpack.cloudfoundry.org/jvmkill/bionic/x86_64/jvmkill-1.16.0-RELEASE.so (found in cache)
   -----&gt; Downloading Open Jdk JRE 11.0.6_10 from https://java-buildpack.cloudfoundry.org/openjdk/bionic/x86_64/openjdk-jre-11.0.6_10-bionic.tar.gz (found in cache)
          Expanding Open Jdk JRE to .java-buildpack/open_jdk_jre (1.1s)
          JVM DNS caching disabled in lieu of BOSH DNS caching
   -----&gt; Downloading Open JDK Like Memory Calculator 3.13.0_RELEASE from https://java-buildpack.cloudfoundry.org/memory-calculator/bionic/x86_64/memory-calculator-3.13.0-RELEASE.tar.gz (found in cache)
          Loaded Classes: 18722, Threads: 250
   -----&gt; Downloading Client Certificate Mapper 1.11.0_RELEASE from https://java-buildpack.cloudfoundry.org/client-certificate-mapper/client-certificate-mapper-1.11.0-RELEASE.jar (found in cache)
   -----&gt; Downloading Container Security Provider 1.16.0_RELEASE from https://java-buildpack.cloudfoundry.org/container-security-provider/container-security-provider-1.16.0-RELEASE.jar (found in cache)
â­ï¸â­ï¸â­ï¸   -----&gt; Downloading Spring Auto Reconfiguration 2.11.0_RELEASE from https://java-buildpack.cloudfoundry.org/auto-reconfiguration/auto-reconfiguration-2.11.0-RELEASE.jar (found in cache)</code></pre>
<h2 is-upgraded>java-cfenvãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨</h2>
<p>ä¸€è¦‹ä¾¿åˆ©ãªAuto-Reconfigurationã§ã™ãŒã€æ¬ ç‚¹ãŒã‚ã‚‹ãŸã‚Productionç’°å¢ƒã§ã®åˆ©ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚Auto-Reconfigurationã¯Spring BootãŒã§ãã‚‹å‰ã«ä½œã‚‰ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚Šã€Spring BootãŒæä¾›ã™ã‚‹<code>DataSource</code>ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£(<code>spring.datasource.hikari.maximum-pool-size</code>ãªã©)ã‚’ç„¡è¦–ã—ã¾ã™ã€‚ã¾ãŸConnection Poolã®æœ€å¤§æ¥ç¶šæ•°ã‚’4ã¨å°ã•ã„å€¤ã«è¨­å®šã—ã¾ã™ã€‚</p>
<p>Auto-Reconfigurationã®ä»£ã‚ã‚Šã«<a href="https://github.com/pivotal-cf/java-cfenv" target="_blank">java-cfenv</a>ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æŒã¤æ¥ç¶šæƒ…å ±ã‚’Spring Bootã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£(<code>spring.datasource.url</code>ãªã©)ã«è‡ªå‹•ã§å¤‰æ›ã™ã‚‹ã ã‘ã«ç•™ã‚ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚ŠAuto-Reconfigurationã®ã‚ˆã†ãªè‡ªå‹•è¨­å®šã®åˆ©ä¾¿æ€§ã‚’æ®‹ã—ã¤ã¤ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ãŸã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br>Auto-Reconfigurationã‚’ç„¡åŠ¹ã«ã—ã€java-cfenvã‚’ä½¿ã£ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚<br><br>pom.xmlã«æ¬¡ã®<code>&lt;dependency&gt;</code>ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;io.pivotal.cfenv&lt;/groupId&gt;
            &lt;artifactId&gt;java-cfenv-boot&lt;/artifactId&gt;
            &lt;version&gt;2.1.2.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;</code></pre>
<p><code>manifest.yml</code>ã«æ¬¡ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã€Auto-Reconfigurationã‚’ç„¡åŠ¹ã«ã—ã¾ã™ã€‚ã¾ãŸã€ç’°å¢ƒå¤‰æ•°<code>SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE</code>ã‚’è¨­å®šã—ã€Connection Poolã®æœ€å¤§æ¥ç¶šæ•°ã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ã¾ã™ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  - car-db
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    # â­ï¸â­ï¸â­ï¸
    JBP_CONFIG_SPRING_AUTO_RECONFIGURATION: &#39;{enabled: false}&#39;
    SPRING_PROFILES_ACTIVE: cloud
    SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: 2
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    INFO_VERSION: 0.0.6 # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<p><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€pushã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true
cf7 push --strategy rolling</code></pre>
<p><code>cf push</code>æ™‚ã®ãƒ­ã‚°ã«<code>&#34;Downloading </code><strong><code>Spring Auto Reconfiguration</code></strong><code> 2.11.0_RELEASE from&#34;</code>ãŒå‡ºåŠ›ã•ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br><br>ã¾ãŸ<code>cf logs</code>ã‚³ãƒãƒ³ãƒ‰ã§æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<code>car-db</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰<code>spring.datasource</code>ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè‡ªå‹•è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>$ cf7 logs hello-cf --recent
...
   2020-07-23T19:03:38.80+0900 [APP/PROC/WEB/0] OUT 2020-07-23 10:03:38.809  INFO 14 --- [           main] s.b.CfDataSourceEnvironmentPostProcessor : Setting spring.datasource properties from bound service [car-db]
...</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Oracle Databaseã«ã‚¢ã‚¯ã‚»ã‚¹" duration="15">
        <p>(ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯èª¬æ˜ã®ã¿ã§æ¼”ç¿’ã¯è¡Œã„ã¾ã›ã‚“)</p>
<p>Oracle Databaseã®ã‚ˆã†ã«Marketplaceã«ServiceãŒç™»éŒ²ã•ã‚Œã¦ãªã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã¯ã€<strong>Provisionæ¸ˆã¿ã®æƒ…å ±</strong>ã‚’User Provided Serviceã¾ãŸã¯Credhub Service Brokerã«æ¥ç¶šæƒ…å ±ã‚’ç™»éŒ²ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚</p>
<h2 is-upgraded>Connection Type: SIDã®å ´åˆ</h2>
<p>SIDã§æ¥ç¶šã™ã‚‹å ´åˆã¯ã€æ¬¡ã®å½¢å¼ã§ã‚ã‚Œã°Buildpackã®Auto Reconfigurationã¾ãŸã¯java-cfenvãŒè‡ªå‹•ã§Spring Bootã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¨­å®šã—ã¦ãã‚Œã¾ã™ã€‚</p>
<pre><code># User Provided Serviceã®å ´åˆ
cf create-user-provided-service car-db -p &#39;{&#34;url&#34;:&#34;oracle://scott:tiger@oracle.example.com:1521/CARCDB&#34;}&#39;</code></pre>
<pre><code># Credhub Service Brokerã®å ´åˆ
cf create-service credhub default car-db -c &#39;{&#34;url&#34;:&#34;oracle://scott:tiger@oracle.example.com:1521/CARCDB&#34;}&#39;</code></pre>
<p>PostgreSQLã®å ´åˆã¨<code>manfeifest.yml</code>ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br></p>
<h2 is-upgraded>Connection Type: Service Nameã®å ´åˆ</h2>
<p>Service Nameã§æ¥ç¶šã™ã‚‹å ´åˆã¯ã€Auto Reconfigurationã¾ãŸã¯java-cfenvãŒç¾æ™‚ç‚¹(July 2020)ã§å¯¾å¿œã—ã¦ã„ãªã„ã®ã§ã€Auto Reconfigurationã¾ãŸã¯java-cfenvã¯ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚æ¬¡ã®å½¢å¼ã§Serviceã«æ¥ç¶šæƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<pre><code># User Provided Serviceã®å ´åˆ
cf create-user-provided-service car-db -p &#39;{&#34;username&#34;:&#34;scott&#34;, &#34;password&#34;:&#34;tiger&#34;, &#34;jdbcUrl&#34;:&#34;jdbc:oracle:thin:@//oracle.example.com:1521/CARCDB&#34;}&#39;</code></pre>
<pre><code># Credhub Service Brokerã®å ´åˆ
cf create-service credhub default car-db -c &#39;{&#34;username&#34;:&#34;scott&#34;, &#34;password&#34;:&#34;tiger&#34;, &#34;jdbcUrl&#34;:&#34;jdbc:oracle:thin:@//oracle.example.com:1521/CARCDB&#34;}&#39;</code></pre>
<p><code>manifest.yml</code>ã¯æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚<strong>ã¾ãŸã€</strong><strong><code>pom.xml</code></strong><strong>ã‹ã‚‰java-cfenvã®</strong><strong><code>&lt;dependency&gt;</code></strong><strong>ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚</strong></p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  - car-db
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    JBP_CONFIG_SPRING_AUTO_RECONFIGURATION: &#39;{enabled: false}&#39;
    SPRING_PROFILES_ACTIVE: cloud
    # â­ï¸â­ï¸â­ï¸
    SPRING_DATASOURCE_USERNAME: ${vcap.services.car-db.credentials.username}
    SPRING_DATASOURCE_PASSWORD: ${vcap.services.car-db.credentials.password}
    SPRING_DATASOURCE_URL: ${vcap.services.car-db.credentials.jdbcUrl}
    SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: 2
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    INFO_VERSION: 0.0.6
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<h2 is-upgraded>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´</h2>
<p>PostgreSQLã§ã¯ãªãOracle DBã‚’ä½¿ã†ã‚ˆã†ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</p>
<p><code>pom.xml</code></p>
<pre><code>    &lt;dependency&gt;
      &lt;groupId&gt;com.oracle.ojdbc&lt;/groupId&gt;
      &lt;artifactId&gt;ojdbc8&lt;/artifactId&gt;
      &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;

&lt;!-- PostgreSQL Driverã¯ä¸è¦
    &lt;dependency&gt;
      &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
      &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
      &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
--&gt;

&lt;!-- Connection Type: Service Nameã®å ´åˆã€java-cfenv-bootã‚’é™¤å¤–
        &lt;dependency&gt;
            &lt;groupId&gt;io.pivotal.cfenv&lt;/groupId&gt;
            &lt;artifactId&gt;java-cfenv-boot&lt;/artifactId&gt;
            &lt;version&gt;2.1.2.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
--&gt;</code></pre>
<p><code><br>src/main/resources/application.properties</code></p>
<pre><code># Localç”¨ã®ãƒ€ãƒŸãƒ¼è¨­å®š
spring.datasource.username=scott
spring.datasource.password=tiger
spring.datasource.url=jdbc:oracle:thin:@localhost:1521:orcl
spring.datasource.driver-class-name=oracle.jdbc.OracleDriver

# å¯¾è±¡ã®ã‚¹ã‚­ãƒ¼ãƒãŒç©ºã§ãªã„å ´åˆã¯ã€ç¾çŠ¶ã‚’version 0ã¨ã—ã¦DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã™ã‚‹
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=0
spring.flyway.baseline-description=Reset baseline</code></pre>
<p><code><br>src/main/resources/db/migration/V1__init.sql</code></p>
<pre><code>CREATE TABLE car (
    id   NUMBER GENERATED ALWAYS AS IDENTITY,
    name VARCHAR2(16)
);

INSERT INTO car(name) VALUES (&#39;Avalon&#39;);
INSERT INTO car(name) VALUES (&#39;Corolla&#39;);
INSERT INTO car(name) VALUES (&#39;Crown&#39;);
INSERT INTO car(name) VALUES (&#39;Levin&#39;);
INSERT INTO car(name) VALUES (&#39;Yaris&#39;);
INSERT INTO car(name) VALUES (&#39;Vios&#39;);
INSERT INTO car(name) VALUES (&#39;Glanza&#39;);
INSERT INTO car(name) VALUES (&#39;Aygo&#39;);</code></pre>
<p><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€pushã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true
cf7 push --strategy rolling</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Metric Registrarã‚’ä½¿ã£ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†" duration="90">
        <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã—ã¾ã™ã€‚Tanzu Application Serviceã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã—å¯¾ã—ã¦ã€<a href="https://docs.pivotal.io/platform/application-service/2-9/metric-registrar/index.html" target="_blank">Metric Registrar</a>ã‚’ä½¿ã£ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã€Platformã«è»¢é€ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ<a href="https://prometheus.io" target="_blank">Prometheus</a>å½¢å¼ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¿”ã™HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€Metric Registrarã¯å®šæœŸçš„ã«ãã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚<br>Metrics Registrarã«ã‚ˆã£ã¦Platformã«è»¢é€ã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ã€å‰è¿°ã®App Metricsã‚„Grafanaã§è¦–è¦šåŒ–ã§ãã¾ã™ã€‚</p>
<h2 is-upgraded>Metric Registrarã§Prometheusã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç™»éŒ²</h2>
<p>æ—¢ã«<code>hello-cf</code>ã‚¢ãƒ—ãƒªã¯Spring Boot Actuatorã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä¸€ã¤ã¨ã—ã¦Prometheusã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ãã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>curl -s https://${HOST}.apps.dev.example.com/actuator/prometheus</code></pre>
<p>Metics RegisrarãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Prometheusã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«<a href="https://github.com/pivotal-cf/metric-registrar-cli" target="_blank">Metrics Registrar Plugin</a>ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>$ cf7 install-plugin -r CF-Community &#34;metric-registrar&#34;
Searching CF-Community for plugin metric-registrar...
Plugin metric-registrar 1.3.0 found in: CF-Community
Plugin metric-registrar 1.3.0 is already installed.
Attention: Plugins are binaries written by potentially untrusted authors.
Install and use plugins at your own risk.
Do you want to uninstall the existing plugin and install metric-registrar 1.3.0? [yN]: y
Starting download of plugin binary from repository CF-Community...
 9.88 MiB / 9.88 MiB [==============================================================================================================] 100.00% 1s
Installing plugin metric-registrar...
OK

Plugin metric-registrar 1.3.0 successfully installed.</code></pre>
<p><code>cf register-metrics-endpoint</code>ã‚³ãƒãƒ³ãƒ‰ã§Prometheusã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚<br></p>
<pre><code>cf7 register-metrics-endpoint hello-cf /actuator/prometheus</code></pre>
<p>ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯å®Ÿéš›ã«ã¯<code>metrics-endpoint-actuator-prometheus</code>ã¨ã„ã†åå‰ã®User Provided Serviceã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€<code>hello-cf</code>ã‚¢ãƒ—ãƒªã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚<code>cf services</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã¨ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf7 services
Getting services in org hol / space tmaki as tmaki@pivotal.io...

name                                   service         plan      bound apps   last operation     broker           upgrade available
car-db                                 elephantsql     turtle    hello-cf     create succeeded   elephantsql      
hello                                  credhub         default   hello-cf     create succeeded   credhub-broker   
â­ï¸â­ï¸â­ï¸metrics-endpoint-actuator-prometheus   user-provided             hello-cf  </code></pre>
<p>å®Ÿéš›ã«ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã¨åŒã˜ã§ã™ã€‚Metrics Registrar Pluginã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸããªã„å ´åˆã¯ã€ã“ã¡ã‚‰ã®æ–¹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚<br></p>
<pre><code>cf7 create-user-provided-service metrics-endpoint-actuator-prometheus -l metrics-endpoint:///actuator/prometheus
cf7 bind-service hello-cf metrics-endpoint-actuator-prometheus</code></pre>
<p><code>metrics-endpoint-actuator-prometheus</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç¶™ç¶šã—ã¦ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã‚‹ã‚ˆã†ã«<code>manifest.yml</code>ã®<code>services</code>ã«<code>metrics-endpoint-actuator-prometheus</code>ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚pushã¯ã—ãªãã¦ã‚‚è‰¯ã„ã§ã™ã€‚</p>
<pre><code>  services:
  - hello
  - car-db
  - metrics-endpoint-actuator-prometheus # â­ï¸â­ï¸â­ï¸</code></pre>
<aside class="special"><p>Note: Metrics Registrar Pluginã§ä½œæˆã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã®å‘½åè¦ç´„ã¯&#34;<code>metrics-endpoint-&lt;ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®</code>ãƒ‘ã‚¹åã®/ã‚’-ã«ç½®æ›ã—ãŸæ–‡å­—åˆ—&gt;&#34;ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å˜ä½ã«ä½œæˆã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªãã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ‘ã‚¹å˜ä½ã§ä½œæˆã•ã‚Œã¾ã™ã€‚</p>
</aside>
<p><br>Metrics RegistrarãŒç™»éŒ²ã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‹ã‚’<code>cf logs</code>ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ã¾ã™ã€‚<code>/actuator/prometheu</code>sã«å¯¾ã™ã‚‹ã€<code>Go-http-client/1.1</code>ã¨ã„ã†User-Agentã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>$ cf7 logs hello-cf --recent
...
   2020-07-24T02:12:49.38+0900 [RTR/0] OUT hello-cf-chatty-platypus.apps.dev.example.com - [2020-07-23T17:12:49.374573051Z] &#34;GET /actuator/prometheus HTTP/1.1&#34; 200 0 11804 &#34;-&#34; &#34;Go-http-client/1.1&#34; &#34;172.19.0.50:59578&#34; &#34;172.19.0.48:61038&#34; x_forwarded_for:&#34;172.19.0.50&#34; x_forwarded_proto:&#34;https&#34; vcap_request_id:&#34;e052006c-95ee-4f1e-455b-653adc025895&#34; response_time:0.007357 gorouter_time:0.000259 app_id:&#34;3869fd37-56c7-4586-928f-7105ddcb3e64&#34; app_index:&#34;0&#34; x_b3_traceid:&#34;b161fdfa90cb0075&#34; x_b3_spanid:&#34;b161fdfa90cb0075&#34; x_b3_parentspanid:&#34;-&#34; b3:&#34;b161fdfa90cb0075-b161fdfa90cb0075&#34;
   2020-07-24T02:12:49.38+0900 [RTR/0] OUT

...</code></pre>
<p>Metrics RegistartçµŒç”±ã§Platformã«æµã‚Œã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§<a href="https://github.com/cloudfoundry/log-cache-cli" target="_blank">Log Cache Plugin</a>ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>$ cf7 install-plugin -r CF-Community &#34;log-cache&#34;  

Searching CF-Community for plugin log-cache...
Plugin log-cache 2.1.0 found in: CF-Community
Attention: Plugins are binaries written by potentially untrusted authors.
Install and use plugins at your own risk.
Do you want to install the plugin log-cache? [yN]: y
Starting download of plugin binary from repository CF-Community...
 12.49 MiB / 12.49 MiB [============================================================================================================] 100.00% 2s
Installing plugin log-cache...
OK

Plugin log-cache 2.1.0 successfully installed.</code></pre>
<p><code>cf tail</code>ã‚³ãƒãƒ³ãƒ‰ã§æµã‚Œã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¿½è·¡ã§ãã¾ã™ã€‚<code>jvm_memory_max_bytes</code>ãªã©ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚Œã°Spring Boot Actuatorã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå–å¾—ã§ãã¦ã„ã¾ã™ã€‚<br></p>
<pre><code>$ cf7 tail --envelope-class=metrics hello-cf -f
Retrieving logs for app hello-cf in org hol / space tmaki as tmaki@pivotal.io...

   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE jvm_memory_max_bytes:5832704.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE jvm_memory_max_bytes:5111808.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE jvm_memory_max_bytes:117817344.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE jvm_memory_max_bytes:122912768.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE hikaricp_connections_creation_seconds_max:0.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE tomcat_sessions_active_max_sessions:0.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE hikaricp_connections_min:5.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] COUNTER tomcat_sessions_expired_sessions_total:0
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE jvm_buffer_total_capacity_bytes:0.000000 
   2020-07-24T02:23:54.37+0900 [hello-cf/0] GAUGE jvm_buffer_total_capacity_bytes:81920.000000 
   2020-07-24T02:23:58.47+0900 [hello-cf/0] GAUGE cpu:0.334983 percentage disk:153645056.000000 bytes disk_quota:2126941871.000000 bytes memory:217696174.000000 bytes memory_quota:805306368.000000 bytes
   2020-07-24T02:23:58.47+0900 [hello-cf/0] GAUGE absolute_entitlement:3007833322610.000000 nanoseconds absolute_usage:95207805940.000000 nanoseconds container_age:26424755687046.000000 nanoseconds
   2020-07-24T02:23:58.47+0900 [hello-cf/0] GAUGE spike_end:1595498742.000000 seconds spike_start:1595498622.000000 seconds</code></pre>
<p>Metrics Registrarã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç™»éŒ²ã€ãŠã‚ˆã³ç¢ºèªã¯Apps Managerã‹ã‚‰ã‚‚è¡Œãˆã¾ã™ã€‚å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®&#34;Settings&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€&#34;Metric Registrar&#34;ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/80b8e1908b9bb08d.png"></p>
<h2 is-upgraded><br>App Metricsã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèª</h2>
<p>Metrics Registrarã§ç™»éŒ²ã—ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’App Metricsã§ç¢ºèªã—ã¾ã™ã€‚App Metricsã¯ä»»æ„ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ã‚°ãƒ©ãƒ•ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãã¾ã™ã€‚App Metricsã¯UAAã«ã‚ˆã‚‹èªå¯åˆ¶å¾¡ãŒè¡Œã‚ã‚Œã‚‹ãŸã‚ã€è‡ªåˆ†ã®ç®¡ç†ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã¿è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br><a href="https://docs.pivotal.io/app-metrics/2-0/using.html" target="_blank">https://docs.pivotal.io/app-metrics/2-0/using.html</a><br>Spring Boot Actuatorã§å–å¾—ã§ãã‚‹ä¸€éƒ¨ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚°ãƒ©ãƒ•ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
<p><a href="https://gist.githubusercontent.com/making/636920436c42c82706420ec830856dc4/raw/170528ccbd14fcd35482436ca13bf8afabd36851/demo.yml" target="_blank">ã“ã¡ã‚‰</a>ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€<code>demo.yml</code>ã¨ã„ã†åå‰ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚°ãƒ©ãƒ•ã‚’è¿½åŠ ã§ãã¾ã™ã€‚<code>demo.yml</code>ã‚’é–‹ãã€æ¬¡ã®ç®‡æ‰€ã‚’è‡ªåˆ†ã®Org,Space,Appã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>spec:
  product:
    name: demo,demo,demo-micrometer</code></pre>
<p>â†“</p>
<pre><code>spec:
  product:
    name: hol,tmaki,hello-cf</code></pre>
<p>å¤‰æ›´ã—ãŸã‚‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚°ãƒ©ãƒ•ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>curl -sv https://metrics.sys.dev.example.com/indicator-documents -H &#34;Authorization: $(cf7 oauth-token)&#34; --data-binary @demo.yml</code></pre>
<p>App Metricsã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚°ãƒ©ãƒ•ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/1691e2baa584a4ec.png"></p>
<h2 is-upgraded>Grafanaã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèª</h2>
<p>Platform Engineerã®è¦³ç‚¹ã‹ã‚‰Platformã«æµã‚Œã‚‹å…¨ã¦ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã¾ã¨ã‚ã¦ã¿ãŸã„ã¨ã„ã†å ´åˆã€<a href="https://docs.pivotal.io/platform/healthwatch/2-0/index.html" target="_blank">Healthwatch2</a>ã®GrafanaãŒåˆ©ç”¨ã§ãã¾ã™ã€‚</p>
<p>Grafanaã§Spring Boot Actuatorã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¦‹ãŸã„å ´åˆã¯ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®Tagã¨ã—ã¦ã‚¢ãƒ—ãƒªã®è­˜åˆ¥å­ã‚’æ˜ç¤ºçš„ã«è¿½åŠ ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®GUIDã§è­˜åˆ¥ã•ã‚Œã¾ã™ãŒã€GUIDã ã‘ã§ã¯ã©ã®ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãªã®ã‹ã‚’åˆ¤åˆ¥ã—ã¥ã‚‰ã„ã§ã™ã€‚<br>Spring Boot Actuatorã§ã¯<code>management.metrics.tags.XXXX</code>ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ä»»æ„ã®Tagã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãã¾ã™ã€‚<code>manifest.yml</code>ã«æ¬¡ã®ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã—ã€Tagã¨ã—ã¦Orgåã€Spaceåã€Appåã€Indexã‚’ä»˜ä¸ã—ã¾ã™ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 768m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  - car-db
  - metrics-endpoint-actuator-prometheus
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;
    JBP_CONFIG_SPRING_AUTO_RECONFIGURATION: &#39;{enabled: false}&#39;
    SPRING_PROFILES_ACTIVE: cloud
    SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: 2
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    # â­ï¸â­ï¸â­ï¸
    MANAGEMENT_METRICS_TAGS_ORGANIZATION: ${vcap.application.organization_name}
    MANAGEMENT_METRICS_TAGS_SPACE: ${vcap.application.space_name}
    MANAGEMENT_METRICS_TAGS_APPLICATION: ${vcap.application.application_name}
    MANAGEMENT_METRICS_TAGS_INSTANCE_ID: ${management.metrics.tags.application}:${vcap.application.instance_index}
    INFO_VERSION: 0.0.7 # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<p>pushã—ã¦è¨­å®šã‚’åæ˜ ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>cf7 push --strategy rolling</code></pre>
<p>Healthwatch2ã®Grafanaã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€Spring Bootã®Dashboard[3]ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/473686de5b037c1.png"></p>
<h2 is-upgraded>ãƒ¡ãƒ¢ãƒªã®ç¯€ç´„</h2>
<p>App Metricsã‚ã‚‹ã„ã¯Grafanaã§hello-cfã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¦‹ã‚‹ã¨ãƒ¡ãƒ¢ãƒªã®ä½¿ç”¨ç‡ãŒã‚ã¾ã‚Šé«˜ããªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚768MBã®ãƒ¡ãƒ¢ãƒªã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸãŒã€ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚‚ã£ã¨å°‘ãªãã¦ã‚‚å¤§ä¸ˆå¤«ãã†ã§ã™ã€‚<br>Javaã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã¯Java Buildpackã«å«ã¾ã‚Œã‚‹<a href="https://github.com/cloudfoundry/java-buildpack-memory-calculator/tree/v3.13.0.RELEASE" target="_blank">Memory Calculator</a>ã‚ˆã£ã¦æ¬¡ã®å›³ã®ã‚ˆã†ã«è‡ªå‹•ã§æ±ºã¾ã‚Šã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/a00e6f9fa2cc1956.png"></p>
<p>å›ºå®šå€¤ã¨ã—ã¦ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹Reserved Code Cacheã®240MBã¨ã€Thread Stackã®250MB (1ã‚¹ãƒ¬ãƒƒãƒ‰ã‚ãŸã‚Š1MB x 250ã‚¹ãƒ¬ãƒƒãƒ‰)ã®å‰²åˆãŒå¤šãã€ã“ã“ã‚’å°ã•ãã™ã‚Œã°768MBã‹ã‚‰å¤§ããæ¸›ã‚‰ã›ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<br>ã“ã“ã§ã¯Reserved Code Cacheã‚’32MBã€Thread Stackã‚’10MB (1ã‚¹ãƒ¬ãƒƒãƒ‰ã‚ãŸã‚Š512KB x 20ã‚¹ãƒ¬ãƒƒãƒ‰)ã«å¤‰æ›´ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºã‚’256MBã¾ã§å°ã•ãã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br>ãªãŠã€æƒ³å®šã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’20ã«æ¸›ã‚‰ã™ã«ã‚ãŸã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼(Tomcat)ãŒã“ã‚Œã‚ˆã‚Šå¤šãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ãªã„ã‚ˆã†ã«ã€<code>servcer.tomcat.threads.max</code>ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä¸Šé™å€¤ã‚’è¨­å®šã—ã¦ãŠãã¾ã™ã€‚<br></p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 256m # â­ï¸â­ï¸â­ï¸
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - hello
  - car-db
  - metrics-endpoint-actuator-prometheus
  env:
    JAVA_OPTS: -XX:ReservedCodeCacheSize=32M -Xss512k # â­ï¸â­ï¸â­ï¸
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{memory_calculator: {stack_threads: 20}, jre: {version: 11.+}}&#39; # â­ï¸â­ï¸â­ï¸
    JBP_CONFIG_SPRING_AUTO_RECONFIGURATION: &#39;{enabled: false}&#39;
    SPRING_PROFILES_ACTIVE: cloud
    SERVER_TOMCAT_THREADS_MAX: 4 # â­ï¸â­ï¸â­ï¸
    SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: 2
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: info,health,env,prometheus
    MANAGEMENT_METRICS_TAGS_ORGANIZATION: ${vcap.application.organization_name}
    MANAGEMENT_METRICS_TAGS_SPACE: ${vcap.application.space_name}
    MANAGEMENT_METRICS_TAGS_APPLICATION: ${vcap.application.application_name}
    MANAGEMENT_METRICS_TAGS_INSTANCE_ID: ${management.metrics.tags.application}:${vcap.application.instance_index}
    INFO_VERSION: 0.0.8 # â­ï¸
    INFO_JAVA_VERSION: ${java.runtime.version}
    INFO_JAVA_VENDOR: ${java.vm.vendor}
    API_KEY: ${vcap.services.hello.credentials.api-key}</code></pre>
<p>pushã—ã¦è¨­å®šã‚’åæ˜ ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>cf7 push --strategy rolling</code></pre>
<h2 is-upgraded>ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ä½œæˆ</h2>
<p>ã“ã“ã¾ã§ã¿ã¦ããŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ãƒ™ãƒ«ã§ã‚ã£ãŸã‚Šã€JVMã‚„HTTPãƒ¬ãƒ™ãƒ«ã§ã‚ã£ãŸã‚Šã¨ã‚·ã‚¹ãƒ†ãƒ è¦³ç‚¹ã§ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã—ãŸã€‚ãƒ“ã‚¸ãƒã‚¹è¦³ç‚¹ã§ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ãŸã„å ´åˆã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å®Ÿè£…ã«ã¯Spring Boot Actuatorã®å†…éƒ¨ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹<a href="https://micrometer.io/" target="_blank">Micrometer</a>ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
<p>Micrometerã§ã¯ä¸»ã«æ¬¡ã®3ã¤ã®Metrics Typeã‚’ä½¿ç”¨ã—ã¾ã™[4]ã€‚</p>
<ul>
<li><a href="https://micrometer.io/docs/concepts#_gauges" target="_blank">Gauge</a> ... å¢—æ¸›ã™ã‚‹å€¤ã®ç¾åœ¨å€¤ã‚’ç¤ºã—ã¾ã™ (ä¾‹: é€Ÿåº¦è¨ˆ)</li>
<li><a href="https://micrometer.io/docs/concepts#_counters" target="_blank">Counter</a> ... å¢—åŠ ã™ã‚‹å€¤ã®ç¾åœ¨å€¤[5]ã‚’ç¤ºã—ã¾ã™ (ä¾‹: ä¸‡æ­©è¨ˆ)</li>
<li><a href="https://micrometer.io/docs/concepts#_timers" target="_blank">Timer</a> ... ã‚ã‚‹å‡¦ç†ã®å®Ÿè¡Œå›æ•°ãŠã‚ˆã³å‡¦ç†æ™‚é–“ã®åˆè¨ˆ[6]ã‚’ç¤ºã—ã¾ã™ (ä¾‹: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ )</li>
</ul>
<p>ã“ã“ã§ã¯Gaugeã¨Counterã‚’ä½¿ã£ãŸç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’è©¦ã—ã¾ã™ã€‚</p>
<p><code>src/main/java/com/example/DemoMetricsController.java</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>package com.example;

import java.util.concurrent.atomic.AtomicLong;

import io.micrometer.core.instrument.MeterRegistry;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class DemoMetricsController {
        private final MeterRegistry meterRegistry;

        private final AtomicLong gauge = new AtomicLong(0L);

        public DemoMetricsController(MeterRegistry meterRegistry) {
                this.meterRegistry = meterRegistry;
        }

        @GetMapping(&#34;/demo_gauge&#34;)
        public ResponseEntity&lt;String&gt; customMetric(@RequestParam(value = &#34;delta&#34;, defaultValue = &#34;1&#34;) long delta) {
                final AtomicLong demoGauge = this.meterRegistry.gauge(&#34;demo.gauge&#34;, this.gauge);
                demoGauge.addAndGet(delta);
                return ResponseEntity.ok(&#34;Gauge&#34;);
        }

        @GetMapping(&#34;/demo_counter&#34;)
        public ResponseEntity&lt;String&gt; simple() {
                this.meterRegistry.counter(&#34;demo.counter&#34;).increment();
                return ResponseEntity.ok(&#34;Counter&#34;);
        }
}</code></pre>
<p><br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€pushã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true
cf7 push --strategy rolling</code></pre>
<p><br>æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ä½•å›ã‹ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>curl https://${HOST}.apps.dev.example.com/demo_counter
curl &#34;https://${HOST}.apps.dev.example.com/demo_gauge?delta=1&#34;
curl &#34;https://${HOST}.apps.dev.example.com/demo_gauge?delta=-1&#34;</code></pre>
<p><code>/actuator/prometheus</code>ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</p>
<ul>
<li><code>demo_gauge</code></li>
<li><code>demo_counter_total</code></li>
</ul>
<p>ã¨ã„ã†ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<h2 is-upgraded><img style="width: 601.70px" src="img/7f07ae6c423645a3.png"></h2>
<h2 is-upgraded><img style="width: 601.70px" src="img/580612391f662aad.png"></h2>
<p>ã“ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’App Metricsã®Dashboardã«è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚App Metricsã®å³ä¸‹ã®+ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€PromQL Explorerã‚’é–‹ã„ã¦ãã ã•ã„[7]ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/f474f67c66a5d6a9.png"></p>
<p>PromQL Explorerã§ã¯Prometheusã®ã‚¯ã‚¨ãƒªè¨€èªã§ã‚ã‚‹<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank">PromQL</a>ã‚’å®Ÿè¡Œã—çµæœã‚’æç”»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>ã¾ãšã¯Gaugeã‚’æç”»ã—ã¾ã™ã€‚<br>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«</p>
<pre><code>sum(demo_gauge{source_id=&#34;$sourceId&#34;})</code></pre>
<p>ã‚’å…¥åŠ›ã—ã€&#34;UPDATE CHART&#34;ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<code>demo_gauge</code>ã®ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/d33df4dde5eae370.png"></p>
<p>æ¬¡ã«Counterã‚’æç”»ã—ã¾ã™ã€‚<br>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«</p>
<pre><code>sum(demo_counter_total{source_id=&#34;$sourceId&#34;})</code></pre>
<p>ã‚’å…¥åŠ›ã—ã€&#34;UPDATE CHART&#34;ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<code>demo_counter_total</code>ã®ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/74e188d9c98d6f9b.png"></p>
<p>Counterã®å ´åˆã¯ã€åˆè¨ˆå€¤ã‚ˆã‚Šã‚‚å¢—åŠ ç‡ã‚’è¨ˆæ¸¬ã—ãŸæ–¹[8]ãŒè‰¯ã„ã§ã™ã€‚å¢—åŠ ç‡ã¯<a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#rate" target="_blank">rate()</a>é–¢æ•°ã§è¨ˆç®—ã§ãã¾ã™ã€‚</p>
<p>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«</p>
<pre><code>sum(rate(demo_counter_total{source_id=&#34;$sourceId&#34;}[3m]))</code></pre>
<p>ã‚’å…¥åŠ›ã—ã€&#34;UPDATE CHART&#34;ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<code>demo_counter_total</code>ã®3åˆ†ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§ã®ç§’é–“å¢—åŠ ç‡ã®ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/d2aec911e50d7569.png"></p>
<p>ã“ã‚Œã‚‰ã®ã‚°ãƒ©ãƒ•ã‚’Dashboardã«è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚<code>demo.yml</code>ã‚’é–‹ãã€<code>indicators</code>ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>  indicators:
  # â­ï¸â­ï¸â­ï¸
  - name: Demo_Counter_Total
    promql: sum(demo_counter_total{source_id=&#34;$sourceId&#34;})
    documentation:
      title: Demo Counter (total)
    presentation:
      units: none
      currentValue: true
  - name: Demo_Counter_Rate
    promql: sum(rate(demo_counter_total{source_id=&#34;$sourceId&#34;}[3m]))
    documentation:
      title: Demo Counter (per sec)
    presentation:
      units: none
      currentValue: true
  - name: Demo_Gauge
    promql: sum(demo_gauge{source_id=&#34;$sourceId&#34;})
    documentation:
      title: Demo Gauge
    presentation:
      units: none
      currentValue: true
  # â­ï¸â­ï¸â­ï¸</code></pre>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚°ãƒ©ãƒ•ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>curl -sv https://metrics.sys.dev.example.com/indicator-documents -H &#34;Authorization: $(cf7 oauth-token)&#34; --data-binary @demo.yml</code></pre>
<p>App Metricsã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚°ãƒ©ãƒ•ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/d0f1139dbe52e439.png"></p>
<p>ã“ã‚Œã§ã‚°ãƒ©ãƒ•ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="Taskã§ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œ" duration="75">
        <p>Cloud Foundryã¯Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ãªå¸¸é§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³(Long Running Process)ã ã‘ã§ãªãçŸ­å‘½ãª<a href="https://docs.cloudfoundry.org/devguide/using-tasks.html" target="_blank">Task</a>ã‚‚å®Ÿè¡Œã§ãã¾ã™ã€‚Taskæ©Ÿèƒ½ã‚’ç”¨ã„ã¦ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚<a href="https://spring.io/projects/spring-batch" target="_blank">Spring Batch</a>ã‚’ä½¿ç”¨ã—ã¦ã€ç°¡å˜ãªãƒãƒƒãƒå‡¦ç†ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<h2 is-upgraded>Taskã®å®Ÿè¡Œ</h2>
<p>ã¾ãšã¯Cloud Foundryã®Taskæ©Ÿèƒ½ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚<code>cf run-task</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚·ãƒ³ãƒ—ãƒ«ãªã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>$ cf7 run-task hello-cf -c &#34;ls -la&#34;
Creating task for app hello-cf in org hol / space tmaki as tmaki@pivotal.io...
Task has been submitted successfully for execution.
OK

task name:   d8589e93
task id:     1</code></pre>
<p>Taskã®å‡ºåŠ›ã¯<code>cf logs</code>ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>$ cf7 logs hello-cf
Retrieving logs for app hello-cf in org hol / space tmaki as tmaki@pivotal.io...
... (ç•¥) ...
   2020-07-25T01:57:31.30+0900 [CELL/0] OUT Cell 16987a3a-95c3-4696-a55a-545b65c79cbc creating container for instance 7ce56f39-6e3a-4aed-b85e-4f70e3651a9a
   2020-07-25T01:57:31.96+0900 [CELL/0] OUT Cell 16987a3a-95c3-4696-a55a-545b65c79cbc successfully created container for instance 7ce56f39-6e3a-4aed-b85e-4f70e3651a9a
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT total 0
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT drwxr-xr-x 1 vcap vcap  72 Jul 23 10:03 .
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT drwx------ 1 vcap vcap  93 Jul 23 10:03 ..
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT drwxr-xr-x 4 vcap vcap  53 Jul 23 10:03 BOOT-INF
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT drwxr-xr-x 6 vcap vcap 115 Jul 23 10:03 .java-buildpack
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT drwxr-xr-x 3 vcap vcap  80 Jul 23 10:03 META-INF
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT drwxr-xr-x 3 vcap vcap  29 Feb  1  1980 org
   2020-07-25T01:57:37.15+0900 [APP/TASK/d8589e93/0] OUT Exit status 0
   2020-07-25T01:57:37.39+0900 [CELL/0] OUT Cell 16987a3a-95c3-4696-a55a-545b65c79cbc stopping instance 7ce56f39-6e3a-4aed-b85e-4f70e3651a9a
   2020-07-25T01:57:37.39+0900 [CELL/0] OUT Cell 16987a3a-95c3-4696-a55a-545b65c79cbc destroying container for instance 7ce56f39-6e3a-4aed-b85e-4f70e3651a9a
... (ç•¥) ...</code></pre>
<h2 is-upgraded>Spring Batchã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ</h2>
<p>æ¬¡ã¯Spring Batchã‚’ä½¿ã£ãŸæœ¬æ ¼çš„ãªãƒãƒƒãƒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚<br>Spring Batchã§ã¯&#34;å…¥åŠ› -&gt; åŠ å·¥ -&gt; å‡ºåŠ›&#34;ã®å‡¦ç†ã‚’ãã‚Œãã‚Œ<code>ItemReader</code>ã€<code>ItemProcessor</code>ã€<code>ItemWriter</code>ã§è¡Œã„ã¾ã™ã€‚ä»Šå›ã¯CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ç°¡å˜ãªãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™[9]ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/a1fbd68648325e1e.png"></p>
<p>ã¾ãšã¯Spring Batchã‚’ä½¿ã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é››å½¢ã‚’ä½œæˆã—ã¾ã™ã€‚<br></p>
<pre><code>cd ..
curl https://start.spring.io/starter.tgz \
    -d artifactId=billing-job \
    -d baseDir=billing-job \
    -d packageName=com.example \
    -d dependencies=batch,postgresql,configuration-processor \
    -d applicationName=BillingJobApplication | tar -xzvf -</code></pre>
<pre><code>cd billing-job</code></pre>
<p>â‘  <code>src/main/java/com/example/Bill.jav</code>aã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>package com.example;

import java.math.BigDecimal;
import java.math.RoundingMode;

public class Bill {
    private final Long id;
    private final String firstName;
    private final String lastName;
    private final Long dataUsage;
    private final Long minutes;
    private final BigDecimal billAmount;

    public static Bill fromUsage(Usage usage) {
        final BigDecimal billAmount = calcBillAmount(usage.getDataUsage(), usage.getMinutes());
        return new Bill(usage.getId(), usage.getFirstName(), usage.getLastName(), usage.getDataUsage(), usage.getMinutes(), billAmount);
    }

    public Bill(Long id, String firstName, String lastName, Long dataUsage, Long minutes, BigDecimal billAmount) {
        this.id = id;
        this.firstName = firstName;
        this.lastName = lastName;
        this.dataUsage = dataUsage;
        this.minutes = minutes;
        this.billAmount = billAmount;
    }

    public static BigDecimal calcBillAmount(Long dataUsage, Long minutes) {
        // dataUsage * 0.001 + usageMinutes * 0.01
        return BigDecimal.valueOf(dataUsage).multiply(new BigDecimal(&#34;0.001&#34;))
                .add(BigDecimal.valueOf(minutes).multiply(new BigDecimal(&#34;0.01&#34;)))
                .setScale(2, RoundingMode.FLOOR);
    }

    public Long getId() {
        return id;
    }

    public String getFirstName() {
        return firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public Long getDataUsage() {
        return dataUsage;
    }

    public Long getMinutes() {
        return minutes;
    }

    public BigDecimal getBillAmount() {
        return billAmount;
    }
}</code></pre>
<p>â‘¡ <code>src/main/java/com/example/Usage.java</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>package com.example;

public class Usage {
    private final Long id;
    private final String firstName;
    private final String lastName;
    private final Long minutes;
    private final Long dataUsage;

    public Usage(Long id, String firstName, String lastName, Long minutes, Long dataUsage) {
        this.id = id;
        this.firstName = firstName;
        this.lastName = lastName;
        this.minutes = minutes;
        this.dataUsage = dataUsage;
    }

    public Long getId() {
        return id;
    }

    public String getFirstName() {
        return firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public Long getMinutes() {
        return minutes;
    }

    public Long getDataUsage() {
        return dataUsage;
    }
}</code></pre>
<p>â‘¢ <code>src/main/java/com/example/BillingConfig.java</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>package com.example;

import javax.sql.DataSource;

import org.springframework.batch.core.Job;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.core.configuration.annotation.JobBuilderFactory;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.batch.core.launch.support.RunIdIncrementer;
import org.springframework.batch.item.ItemProcessor;
import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ItemWriter;
import org.springframework.batch.item.database.builder.JdbcBatchItemWriterBuilder;
import org.springframework.batch.item.file.FlatFileItemReader;
import org.springframework.batch.item.file.builder.FlatFileItemReaderBuilder;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.Resource;

@Configuration
@EnableBatchProcessing
public class BillingConfig {
        private final JobBuilderFactory jobBuilderFactory;

        private final StepBuilderFactory stepBuilderFactory;


        public BillingConfig(JobBuilderFactory jobBuilderFactory,
                        StepBuilderFactory stepBuilderFactory) {
                this.jobBuilderFactory = jobBuilderFactory;
                this.stepBuilderFactory = stepBuilderFactory;
        }

        @Bean
        public Job billingJob(ItemReader&lt;Usage&gt; itemReader, ItemProcessor&lt;Usage, Bill&gt; itemProcessor, ItemWriter&lt;Bill&gt; itemWriter) {
                final Step step = this.stepBuilderFactory.get(&#34;BilliProcessing&#34;)
                                .&lt;Usage, Bill&gt;chunk(1000)
                                .reader(itemReader)
                                .processor(itemProcessor)
                                .writer(itemWriter)
                                .build();
                return this.jobBuilderFactory.get(&#34;BillingJob&#34;)
                                .incrementer(new RunIdIncrementer())
                                .start(step)
                                .build();
        }

        @Bean
        @StepScope
        public FlatFileItemReader&lt;Usage&gt; usageItemReader(@Value(&#34;#{jobParameters[&#39;usageInfoFile&#39;]}&#34;) Resource usageInfoFile) {
                return new FlatFileItemReaderBuilder&lt;Usage&gt;()
                                .name(&#34;UsageItemReader&#34;)
                                .resource(usageInfoFile)
                                .delimited()
                                .names(&#34;id&#34;, &#34;firstName&#34;, &#34;lastName&#34;, &#34;minutes&#34;, &#34;dataUsage&#34;)
                                .fieldSetMapper(fs -&gt; new Usage(fs.readLong(&#34;id&#34;),
                                                fs.readString(&#34;firstName&#34;),
                                                fs.readString(&#34;lastName&#34;),
                                                fs.readLong(&#34;minutes&#34;),
                                                fs.readLong(&#34;dataUsage&#34;)))
                                .linesToSkip(1)
                                .build();
        }

        @Bean
        public ItemProcessor&lt;Usage, Bill&gt; billItemProcessor() {
                return new ItemProcessor&lt;Usage, Bill&gt;() {
                        @Override
                        public Bill process(Usage usage) throws Exception {
                                return Bill.fromUsage(usage);
                        }
                };
        }

        @Bean
        public ItemWriter&lt;Bill&gt; jdbcBillWriter(DataSource dataSource) {
                return new JdbcBatchItemWriterBuilder&lt;Bill&gt;()
                                .beanMapped()
                                .dataSource(dataSource)
                                .sql(&#34;INSERT INTO BILL_STATEMENTS (id, first_name, last_name, minutes, data_usage,bill_amount) VALUES (:id, :firstName, :lastName, :minutes, :dataUsage, :billAmount)&#34;)
                                .build();
        }
}</code></pre>
<p>â‘£ <code>src/main/resources/application.properties</code>ã«æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>spring.datasource.initialization-mode=always
spring.batch.initialize-schema=always
spring.datasource.driver-class-name=org.postgresql.Driver

# Localç”¨ã®ãƒ€ãƒŸãƒ¼è¨­å®š
spring.datasource.url=jdbc:postgresql://localhost:5432/billing
spring.datasource.username=${USER}
spring.datasource.password=

# ä½™åˆ†ãªãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãªã„
logging.level.root=WARN
logging.level.com.example=INFO
logging.level.org.springframework.batch=INFO
logging.level.org.springframework.batch.core.step.tasklet.TaskletStep=DEBUG</code></pre>
<p>â‘¤ <code>src/main/resources/schema.sql</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>CREATE TABLE IF NOT EXISTS BILL_STATEMENTS
(
    id          INT,
    first_name  VARCHAR(50),
    last_name   VARCHAR(50),
    minutes     INT,
    data_usage  INT,
    bill_amount DECIMAL(10, 2)
);</code></pre>
<p>â‘¥ <code>src/main/resources/usageinfo.csv</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚(<strong>ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã«ç©ºè¡Œã‚’å…¥ã‚Œãªã„ã§ãã ã•ã„</strong>)</p>
<pre><code>id,firstName,lastName,minutes,dataUsage
1,jane,doe,500,1000
2,john,doe,550,1500
3,melissa,smith,600,1550
4,michael,smith,650,1500
5,mary,jones,700,1500</code></pre>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true</code></pre>
<p>ãƒãƒƒãƒå‡¦ç†ã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<pre><code>cf7 create-service elephantsql turtle billing-db</code></pre>
<p><code>manifest.yml</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: billing-job
  # â­ï¸â­ï¸â­ï¸
  no-route: true
  instances: 0 # â­ï¸â­ï¸â­ï¸
  path: target/billing-job-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  services:
  - billing-db
  env:
    JBP_CONFIG_OPEN_JDK_JRE: &#39;{jre: {version: 11.+}}&#39;</code></pre>
<p><code>cf push</code>ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>cf7 push</code></pre>
<p>Taskã¨ã—ã¦ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ãƒ­ã‚°ã‚’è¿½è·¡ã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>cf7 logs billing-job </code></pre>
<p><code>cf run-task</code>ã‚³ãƒãƒ³ãƒ‰ã§Spring Batchã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Taskã¨ã—ã¦å®Ÿè¡Œ</p>
<pre><code>cf7 run-task billing-job -m 128m -c &#34;.java-buildpack/open_jdk_jre/bin/java org.springframework.boot.loader.JarLauncher usageInfoFile=classpath:usageinfo.csv&#34;</code></pre>
<p>æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>   2020-07-25T13:23:38.67+0900 [API/1] OUT Added process: &#34;task&#34;
   2020-07-25T13:23:39.62+0900 [API/0] OUT Restarted app with guid 3723ce42-081a-4bab-9e24-17a5ef205175
   2020-07-25T13:36:48.91+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd creating container for instance 640a3d59-5ae4-4c98-8a45-699378cc57a2
   2020-07-25T13:36:49.49+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd successfully created container for instance 640a3d59-5ae4-4c98-8a45-699378cc57a2
   2020-07-25T13:36:53.62+0900 [APP/TASK/0a6a4dab/0] OUT   .   ____          _            __ _ _
   2020-07-25T13:36:53.62+0900 [APP/TASK/0a6a4dab/0] OUT  /\\ / ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
   2020-07-25T13:36:53.62+0900 [APP/TASK/0a6a4dab/0] OUT ( ( )\___ | &#39;_ | &#39;_| | &#39;_ \/ _` | \ \ \ \
   2020-07-25T13:36:53.62+0900 [APP/TASK/0a6a4dab/0] OUT  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
   2020-07-25T13:36:53.62+0900 [APP/TASK/0a6a4dab/0] OUT   &#39;  |____| .__|_| |_|_| |_\__, | / / / /
   2020-07-25T13:36:53.62+0900 [APP/TASK/0a6a4dab/0] OUT  =========|_|==============|___/=/_/_/_/
   2020-07-25T13:36:53.62+0900 [APP/TASK/0a6a4dab/0] OUT  :: Spring Boot ::        (v2.3.1.RELEASE)
   2020-07-25T13:36:53.80+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:36:53.795  INFO 14 --- [           main] com.example.BillingJobApplication        : Starting BillingJobApplication v0.0.1-SNAPSHOT on 640a3d59-5ae4-4c98-8a45-699378cc57a2 with PID 14 (/home/vcap/app/BOOT-INF/classes started by vcap in /home/vcap/app)
   2020-07-25T13:36:53.80+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:36:53.800  INFO 14 --- [           main] com.example.BillingJobApplication        : The following profiles are active: cloud
   2020-07-25T13:37:00.42+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:00.420  INFO 14 --- [           main] o.s.b.c.r.s.JobRepositoryFactoryBean     : No database type set, using meta data indicating: POSTGRES
   2020-07-25T13:37:00.44+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:00.443  INFO 14 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : No TaskExecutor has been set, defaulting to synchronous executor.
   2020-07-25T13:37:00.51+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:00.517  INFO 14 --- [           main] com.example.BillingJobApplication        : Started BillingJobApplication in 7.327 seconds (JVM running for 7.937)
   2020-07-25T13:37:04.77+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:04.771  INFO 14 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] launched with the following parameters: [{run.id=1, usageInfoFile=classpath:usageinfo.csv}]
   2020-07-25T13:37:07.61+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:07.613  INFO 14 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [BilliProcessing]
   2020-07-25T13:37:09.09+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:09.093 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Applying contribution: [StepContribution: read=5, written=5, filtered=0, readSkips=0, writeSkips=0, processSkips=0, exitStatus=EXECUTING]
   2020-07-25T13:37:09.29+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:09.294 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Saving step execution before commit: StepExecution: id=1, version=1, name=BilliProcessing, status=STARTED, exitStatus=EXECUTING, readCount=5, filterCount=0, â­ï¸â­ï¸â­ï¸writeCount=5 readSkipCount=0, writeSkipCount=0, processSkipCount=0, commitCount=1, rollbackCount=0, exitDescription=
   2020-07-25T13:37:10.30+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:10.302  INFO 14 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [BilliProcessing] executed in 2s688ms
   2020-07-25T13:37:12.11+0900 [APP/TASK/0a6a4dab/0] OUT 2020-07-25 04:37:12.114  INFO 14 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] completed with the following parameters: [{run.id=1, usageInfoFile=classpath:usageinfo.csv}] and the following status: [COMPLETED] in 6s516ms
   2020-07-25T13:37:12.13+0900 [APP/TASK/0a6a4dab/0] OUT Exit status 0
   2020-07-25T13:37:12.26+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd stopping instance 640a3d59-5ae4-4c98-8a45-699378cc57a2
   2020-07-25T13:37:12.26+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd destroying container for instance 640a3d59-5ae4-4c98-8a45-699378cc57a2
   2020-07-25T13:37:12.58+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd successfully destroyed container for instance 640a3d59-5ae4-4c98-8a45-699378cc57a2</code></pre>
<p>ãƒ­ã‚°ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’5ä»¶å‡¦ç†ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<aside class="warning"><p>Note: Exit <code>status 137 (out of memory)</code>ãŒç™ºç”Ÿã™ã‚‹å ´åˆã¯<code>-m 128m</code>ã‚’<code>-m 256m</code>ã«å¤‰æ›´ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
</aside>
<p>ã‚‚ã†å°‘ã—å¤šãã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¾ã—ã‚‡ã†ã€‚æ¬¡ã¯å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’HTTPçµŒç”±ã§å–å¾—ã—ã¾ã™ã€‚Spring Batchã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰å¼•æ•°ã‚’å¤‰æ›´ã—ã¦<code>cf run-task</code>ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<pre><code>cf7 run-task billing-job -m 128m -c &#34;.java-buildpack/open_jdk_jre/bin/java org.springframework.boot.loader.JarLauncher usageInfoFile=https://github.com/making/fakedata/raw/master/usageinfo/usageinfo-10000-en.csv&#34;</code></pre>
<p>æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>   2020-07-25T13:45:04.86+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd creating container for instance 9afb24e4-a94c-4e0f-8dce-65ed39691fe7
   2020-07-25T13:45:05.48+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd successfully created container for instance 9afb24e4-a94c-4e0f-8dce-65ed39691fe7
   2020-07-25T13:45:09.75+0900 [APP/TASK/9ea5abf4/0] OUT   .   ____          _            __ _ _
   2020-07-25T13:45:09.75+0900 [APP/TASK/9ea5abf4/0] OUT  /\\ / ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
   2020-07-25T13:45:09.75+0900 [APP/TASK/9ea5abf4/0] OUT ( ( )\___ | &#39;_ | &#39;_| | &#39;_ \/ _` | \ \ \ \
   2020-07-25T13:45:09.75+0900 [APP/TASK/9ea5abf4/0] OUT  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
   2020-07-25T13:45:09.75+0900 [APP/TASK/9ea5abf4/0] OUT   &#39;  |____| .__|_| |_|_| |_\__, | / / / /
   2020-07-25T13:45:09.75+0900 [APP/TASK/9ea5abf4/0] OUT  =========|_|==============|___/=/_/_/_/
   2020-07-25T13:45:09.75+0900 [APP/TASK/9ea5abf4/0] OUT  :: Spring Boot ::        (v2.3.1.RELEASE)
   2020-07-25T13:45:09.94+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:09.941  INFO 14 --- [           main] com.example.BillingJobApplication        : Starting BillingJobApplication v0.0.1-SNAPSHOT on 9afb24e4-a94c-4e0f-8dce-65ed39691fe7 with PID 14 (/home/vcap/app/BOOT-INF/classes started by vcap in /home/vcap/app)
   2020-07-25T13:45:09.94+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:09.946  INFO 14 --- [           main] com.example.BillingJobApplication        : The following profiles are active: cloud
   2020-07-25T13:45:16.58+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:16.584  INFO 14 --- [           main] o.s.b.c.r.s.JobRepositoryFactoryBean     : No database type set, using meta data indicating: POSTGRES
   2020-07-25T13:45:16.61+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:16.611  INFO 14 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : No TaskExecutor has been set, defaulting to synchronous executor.
   2020-07-25T13:45:16.68+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:16.685  INFO 14 --- [           main] com.example.BillingJobApplication        : Started BillingJobApplication in 7.396 seconds (JVM running for 8.072)
   2020-07-25T13:45:22.93+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:22.938  INFO 14 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] launched with the following parameters: [{run.id=2, usageInfoFile=https://github.com/making/fakedata/raw/master/usageinfo/usageinfo-10000-en.csv}]
   2020-07-25T13:45:25.77+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:25.775  INFO 14 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [BilliProcessing]
   2020-07-25T13:45:29.03+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:29.037 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Applying contribution: [StepContribution: read=1000, written=1000, filtered=0, readSkips=0, writeSkips=0, processSkips=0, exitStatus=EXECUTING]
   2020-07-25T13:45:29.23+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:29.239 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Saving step execution before commit: StepExecution: id=2, version=1, name=BilliProcessing, status=STARTED, exitStatus=EXECUTING, readCount=1000, filterCount=0, writeCount=1000 readSkipCount=0, writeSkipCount=0, processSkipCount=0, commitCount=1, rollbackCount=0, exitDescription=
   2020-07-25T13:45:30.73+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:30.731 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Applying contribution: [StepContribution: read=1000, written=1000, filtered=0, readSkips=0, writeSkips=0, processSkips=0, exitStatus=EXECUTING]
   2020-07-25T13:45:29.23+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:29.239 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Saving step execution before commit: StepExecution: id=2, version=1, name=BilliProcessing, status=STARTED, exitStatus=EXECUTING, readCount=1000, filterCount=0, writeCount=1000 readSkipCount=0, writeSkipCount=0, processSkipCount=0, commitCount=1, rollbackCount=0, exitDescription=
... (ç•¥) ...
   2020-07-25T13:45:44.80+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:44.808 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Applying contribution: [StepContribution: read=0, written=0, filtered=0, readSkips=0, writeSkips=0, processSkips=0, exitStatus=EXECUTING]
   2020-07-25T13:45:45.00+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:45.009 DEBUG 14 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Saving step execution before commit: StepExecution: id=2, version=11, name=BilliProcessing, status=STARTED, exitStatus=EXECUTING, readCount=10000, filterCount=0, â­ï¸â­ï¸â­ï¸writeCount=10000 readSkipCount=0, writeSkipCount=0, processSkipCount=0, commitCount=11, rollbackCount=0, exitDescription=
   2020-07-25T13:45:46.01+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:46.015  INFO 14 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [BilliProcessing] executed in 20s240ms
   2020-07-25T13:45:47.82+0900 [APP/TASK/9ea5abf4/0] OUT 2020-07-25 04:45:47.825  INFO 14 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] completed with the following parameters: [{run.id=2, usageInfoFile=https://github.com/making/fakedata/raw/master/usageinfo/usageinfo-10000-en.csv}] and the following status: [COMPLETED] in 24s65ms
   2020-07-25T13:45:47.84+0900 [APP/TASK/9ea5abf4/0] OUT Exit status 0
   2020-07-25T13:45:48.34+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd stopping instance 9afb24e4-a94c-4e0f-8dce-65ed39691fe7
   2020-07-25T13:45:48.34+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd destroying container for instance 9afb24e4-a94c-4e0f-8dce-65ed39691fe7
   2020-07-25T13:45:48.64+0900 [CELL/0] OUT Cell 116dd279-04a8-42e6-96cf-493e727bc0bd successfully destroyed container for instance 9afb24e4-a94c-4e0f-8dce-65ed39691fe7</code></pre>
<p>Taskã®å®Ÿè¡Œå±¥æ­´ã¯<code>cf tasks</code>ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>$ cf7 tasks billing-job
Getting tasks for app billing-job in org hol / space tmaki as tmaki@pivotal.io...

id   name       state       start time                      command
2    9ea5abf4   SUCCEEDED   Sat, 25 Jul 2020 04:45:04 UTC   .java-buildpack/open_jdk_jre/bin/java org.springframework.boot.loader.JarLauncher usageInfoFile=https://github.com/making/fakedata/raw/master/usageinfo/usageinfo-10000-en.csv
1    0a6a4dab   SUCCEEDED   Sat, 25 Jul 2020 04:36:48 UTC   .java-buildpack/open_jdk_jre/bin/java org.springframework.boot.loader.JarLauncher usageInfoFile=classpath:usageinfo.csv</code></pre>
<p>Apps Managerã‹ã‚‰ã‚‚Taskã®ç¢ºèªãƒ»å®Ÿè¡Œã‚’è¡Œãˆã¾ã™ã€‚å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®&#34;Tasks&#34;ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img style="width: 601.70px" src="img/373790f47fbc7fcf.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="SMB Service Brokerã§ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰" duration="15">
        <p>ã“ã“ã¾ã§ä½œæˆã—ãŸãƒãƒƒãƒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å…¥åŠ›ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã€ã‚ã‚‹ã„ã¯HTTPçµŒç”±ã§å®Ÿè¡Œæ™‚ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ã‚’ä½¿ã„ã¾ã—ãŸã€‚<br>Tanzu Application Serviceã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘æ¸¡ã—ã™ã‚‹ã®ã«ã€ã‚³ãƒ³ãƒ†ãƒŠä»¥å¤–ã®Volumeã¨ã—ã¦NFSã¾ãŸã¯Sambaã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚Service Brokerã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç”¨æ„ã§ãã¾ã™ã€‚NFSã‚„Sambaã®ã‚µãƒ¼ãƒãƒ¼ã¯åˆ¥é€”æº–å‚™ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>ä»Šå›ã¯Sambaã‚’ä½¿ç”¨ã—ã¦ã€ãƒãƒƒãƒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>Samba 3.0ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦<a href="https://docs.microsoft.com/azure/storage/files/" target="_blank">Azure Files</a>ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br><br>Hands-on Workdshopç”¨ã«æ¬¡ã®ã‚ˆã†ã«10ä¸‡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€<code>usageinfo-100000-en.csv</code>ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p><img style="width: 601.70px" src="img/9d32b1cd7075a902.png"><br><br>ã¾ãšã¯æ¬¡ã®Azure Filesã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code># ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¬›å¸«ã«èã„ã¦ãã ã•ã„
export STORAGE_ACCOUNT_NAME=****
export STORAGE_ACCOUNT_KEY=****
export SHARE_NAME=billing</code></pre>
<p>SMB Service Brokerã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹<code>billing-file</code>ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<pre><code>cf7 create-service smb Existing billing-file -c &#34;{\&#34;share\&#34;: \&#34;//${STORAGE_ACCOUNT_NAME}.file.core.windows.net/${SHARE_NAME}\&#34;, \&#34;version\&#34;: \&#34;3.0\&#34;}&#34;</code></pre>
<p><code>billing-file</code>ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’<code>billing-job</code>ã‚¢ãƒ—ãƒªã«ãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ã€‚</p>
<pre><code>cf7 bind-service billing-job billing-file -c &#34;{\&#34;username\&#34;: \&#34;${STORAGE_ACCOUNT_NAME}\&#34;, \&#34;password\&#34;: \&#34;${STORAGE_ACCOUNT_KEY}\&#34;}&#34;</code></pre>
<p><code>cf env</code>ã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>$ cf7 env billing-job
Getting env variables for app billing-job in org hol / space tmaki as tmaki@pivotal.io...
System-Provided:
VCAP_SERVICES: {
... (ç•¥) ...
 &#34;smb&#34;: [
  {
   &#34;binding_name&#34;: null,
   &#34;credentials&#34;: {},
   &#34;instance_name&#34;: &#34;billing-file&#34;,
   &#34;label&#34;: &#34;smb&#34;,
   &#34;name&#34;: &#34;billing-file&#34;,
   &#34;plan&#34;: &#34;Existing&#34;,
   &#34;provider&#34;: null,
   &#34;syslog_drain_url&#34;: null,
   &#34;tags&#34;: [
    &#34;smb&#34;
   ],
   &#34;volume_mounts&#34;: [
    {
     &#34;container_dir&#34;: &#34;/var/vcap/data/bbc4accc-abb0-4e2f-9178-442eda501978&#34;,
     &#34;device_type&#34;: &#34;shared&#34;,
     &#34;mode&#34;: &#34;rw&#34;
    }
   ]
  }
 ]
}
... (ç•¥) ...</code></pre>
<p>ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ã€Spring Batchã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰å¼•æ•°ã‚’å¤‰æ›´ã—ã¦<code>cf run-task</code>ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<pre><code>cf7 run-task billing-job -m 256m -c &#34;.java-buildpack/open_jdk_jre/bin/java org.springframework.boot.loader.JarLauncher usageInfoFile=file://\$(echo \${VCAP_SERVICES} | jq -r &#39;. [][] | select(.instance_name == \&#34;billing-file\&#34;) | .volume_mounts[0].container_dir&#39;)/usageinfo-100000-en.csv&#34;</code></pre>
<p>æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>   2020-08-04T23:06:24.59+0900 [APP/TASK/c318f441/0] OUT   .   ____          _            __ _ _
   2020-08-04T23:06:24.59+0900 [APP/TASK/c318f441/0] OUT  /\\ / ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
   2020-08-04T23:06:24.59+0900 [APP/TASK/c318f441/0] OUT ( ( )\___ | &#39;_ | &#39;_| | &#39;_ \/ _` | \ \ \ \
   2020-08-04T23:06:24.59+0900 [APP/TASK/c318f441/0] OUT  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
   2020-08-04T23:06:24.59+0900 [APP/TASK/c318f441/0] OUT   &#39;  |____| .__|_| |_|_| |_\__, | / / / /
   2020-08-04T23:06:24.59+0900 [APP/TASK/c318f441/0] OUT  =========|_|==============|___/=/_/_/_/
   2020-08-04T23:06:24.59+0900 [APP/TASK/c318f441/0] OUT  :: Spring Boot ::        (v2.3.1.RELEASE)
   2020-08-04T23:06:24.79+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:24.790  INFO 15 --- [           main] com.example.BillingJobApplication        : Starting BillingJobApplication v0.0.1-SNAPSHOT on 68225a6b-c517-48f6-bd03-f3afe4d4e4d4 with PID 15 (/home/vcap/app/BOOT-INF/classes started by vcap in /home/vcap/app)
   2020-08-04T23:06:24.79+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:24.796  INFO 15 --- [           main] com.example.BillingJobApplication        : The following profiles are active: cloud
   2020-08-04T23:06:31.44+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:31.445  INFO 15 --- [           main] o.s.b.c.r.s.JobRepositoryFactoryBean     : No database type set, using meta data indicating: POSTGRES
   2020-08-04T23:06:31.47+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:31.476  INFO 15 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : No TaskExecutor has been set, defaulting to synchronous executor.
   2020-08-04T23:06:31.57+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:31.576  INFO 15 --- [           main] com.example.BillingJobApplication        : Started BillingJobApplication in 7.46 seconds (JVM running for 8.179)
   2020-08-04T23:06:37.91+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:37.916  INFO 15 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] launched with the following parameters: [{run.id=9, â­ï¸â­ï¸â­ï¸usageInfoFile=file:///var/vcap/data/4e60c7cd-ae37-4a5b-8146-2e50ce49e1f7/usageinfo-100000-en.csv}]
   2020-08-04T23:06:40.78+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:40.781  INFO 15 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [BilliProcessing]
   2020-08-04T23:06:44.69+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:44.694 DEBUG 15 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Applying contribution: [StepContribution: read=1000, written=1000, filtered=0, readSkips=0, writeSkips=0, processSkips=0, exitStatus=EXECUTING]
   2020-08-04T23:06:44.89+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:44.898 DEBUG 15 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Saving step execution before commit: StepExecution: id=9, version=1, name=BilliProcessing, status=STARTED, exitStatus=EXECUTING, readCount=1000, filterCount=0, writeCount=1000 readSkipCount=0, writeSkipCount=0, processSkipCount=0, commitCount=1, rollbackCount=0, exitDescription=
   2020-08-04T23:06:46.41+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:06:46.415 DEBUG 15 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Applying contribution: [StepContribution: read=1000, written=1000, filtered=0, readSkips=0, writeSkips=0, processSkips=0, exitStatus=EXECUTING]
... (ç•¥) ...
   2020-08-04T23:09:27.50+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:09:27.506 DEBUG 15 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Saving step execution before commit: StepExecution: id=9, version=100, name=BilliProcessing, status=STARTED, exitStatus=EXECUTING, readCount=100000, filterCount=0, writeCount=100000 readSkipCount=0, writeSkipCount=0, processSkipCount=0, commitCount=100, rollbackCount=0, exitDescription=
   2020-08-04T23:09:28.11+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:09:28.111 DEBUG 15 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Applying contribution: [StepContribution: read=0, written=0, filtered=0, readSkips=0, writeSkips=0, processSkips=0, exitStatus=EXECUTING]
   2020-08-04T23:09:28.31+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:09:28.313 DEBUG 15 --- [           main] o.s.batch.core.step.tasklet.TaskletStep  : Saving step execution before commit: StepExecution: id=9, version=101, name=BilliProcessing, status=STARTED, exitStatus=EXECUTING, readCount=100000, filterCount=0, â­ï¸â­ï¸â­ï¸writeCount=100000 readSkipCount=0, writeSkipCount=0, processSkipCount=0, commitCount=101, rollbackCount=0, exitDescription=
   2020-08-04T23:09:29.32+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:09:29.325  INFO 15 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [BilliProcessing] executed in 2m48s544ms
   2020-08-04T23:09:31.30+0900 [APP/TASK/c318f441/0] OUT 2020-08-04 14:09:31.302  INFO 15 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] completed with the following parameters: [{run.id=9, usageInfoFile=file:///var/vcap/data/4e60c7cd-ae37-4a5b-8146-2e50ce49e1f7/usageinfo-100000-en.csv}] and the following status: [COMPLETED] in 2m52s552ms</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ãã®ä»–Cloud Nativeãªã‚¢ãƒ—ãƒªã«ã™ã‚‹ãŸã‚ã®è«¸ã€…ã®è€ƒæ…®ãƒã‚¤ãƒ³ãƒˆ" duration="60">
        <h2 is-upgraded>Healthcheck</h2>
<p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®åˆ¤æ–­ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§port(8080)ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ç¢ºèªã•ã‚Œã¾ã™ã€‚portã¯listenã—ã¦ã„ã¦ã‚‚httpãƒ¬ãƒ™ãƒ«ã¯æ©Ÿèƒ½ã—ã¦ã„ãªã„ã¨ã„ã†çŠ¶æ³ã§ãƒªã‚¯ã‚¹ãƒˆãŒæ¥ã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã‚’httpã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã‚ˆã‚Šå®‰å…¨ãªãƒã‚§ãƒƒã‚¯ã«ãªã‚Šã¾ã™ã€‚</p>
<p><a href="https://docs.pivotal.io/platform/application-service/2-8/devguide/deploy-apps/manifest-attributes.html#health-check-http-endpoint" target="_blank">https://docs.pivotal.io/platform/application-service/2-8/devguide/deploy-apps/manifest-attributes.html#health-check-http-endpoint</a></p>
<p><code>manifest.yml</code>ã«<code>health-check-type</code>ã€<code>health-check-http-endpoint</code>ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 256m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  # â­ï¸â­ï¸â­ï¸
  health-check-type: http
  health-check-http-endpoint: /actuator/health
# ä»¥ä¸‹ç•¥...</code></pre>
<p>ã“ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”Ÿãã¦ã„ã‚‹ã‹(liveness)åŠã³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦è‰¯ã„ã‹(readiness)ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€å®šæœŸçš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã¨ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé®æ–­ã•ã‚Œã€ã‚³ãƒ³ãƒ†ãƒŠãŒå†ä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãªç”¨é€”ã§ä½¿ã‚ã‚Œã‚‹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®çµæœã«ã¯<strong>å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„å¤–éƒ¨APIã®åˆ©ç”¨å¯å¦)ã‚’å«ã‚ã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“</strong>ã€‚ä¸€èˆ¬çš„ã«å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’å†ä½œæˆã—ã¦ã‚‚ã€çŠ¶æ³ãŒæ”¹å–„ã—ãªã„ãŸã‚ã§ã™ã€‚å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«éšœå®³ãŒã‚ã‚‹å ´åˆã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’å†ä½œæˆã™ã‚‹ã‚ˆã‚Šã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚<br><code>/actuator/health</code>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯<strong>å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’å«ã‚ã¾ã™ã€‚</strong>ãã®ãŸã‚ã€ä»Šå›ã®ç”¨é€”ã«ã¯å®Ÿã¯é©ã—ã¦ã„ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«<code>/actuator/info</code>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚</p>
<p>Spring Boot 2.3ã‹ã‚‰ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®<strong>å†…éƒ¨çŠ¶æ…‹ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯</strong>ã—ã¦ã€livenessã¨readinessã®çµæœã‚’è¿”ã™ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(<code>/actuator/health/liveness</code>åŠã³<code>/actuator/health/readiness</code>)ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<br><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-kubernetes-probes" target="_blank">https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-kubernetes-probes</a></p>
<p>Tanzu Application Service (Cloud Foundry)ã§ã¯livenessã¨readinessã®ãƒã‚§ãƒƒã‚¯ã‚’åˆ¥ã€…ã«è¡Œã„ã“ã¨ãŒã§ããªã„ãŸã‚ã€è¨­å®šã™ã‚‹ãªã‚‰ã°<code>/actuator/health/readiness</code>ã‚’ä½¿ã†ã¨è‰¯ã„ã§ã™ã€‚livenessã¨readinessã®ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã¯æ¬¡ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<ul>
<li><code>MANAGEMENT_HEALTH_PROBES_ENABLED: true</code> (Spring Boot 2.30 - 2.3.1)</li>
<li>M<code>ANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED: true</code> (Spring Boot 2.3.2ã€œ)<br></li>
</ul>
<aside class="warning"><p>Note: Spring Boot 2.3.2ã§ã¯livenessã¨readinessã®ãƒã‚§ãƒƒã‚¯ãŒ404ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™<a href="https://github.com/spring-projects/spring-boot/issues/22562" target="_blank">ãƒã‚°</a>ãŒã‚ã‚‹ã®ã§åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚2.3.1ã¾ãŸã¯2.3.3ä»¥é™ã§è©¦ã—ã¦ãã ã•ã„ã€‚</p>
</aside>
<p><code>manifest.yml</code>ã®å¤‰æ›´ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br></p>
<pre><code>applications:
- name: hello-cf
  random-route: true
  instances: 1
  memory: 256m
  path: target/hello-cf-0.0.1-SNAPSHOT.jar
  buildpacks: 
  - java_buildpack_offline
  health-check-type: http
  health-check-http-endpoint: /actuator/health/readiness # â­ï¸
# ç•¥...
  env:
    # â­ï¸â­ï¸â­ï¸
    # Spring Boot ~2.3.1
    MANAGEMENT_HEALTH_PROBES_ENABLED: true
    # Spring Boot 2.3.2~
    MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED: true
# ç•¥...</code></pre>
<p>ã‚ã‚‹ã„ã¯<code>application.properties</code>ã«</p>
<pre><code># Spring Boot ~2.3.1
management.health.probes.enabled=true
# Spring Boot 2.3.2~
management.endpoint.health.probes.enabled=true</code></pre>
<p>ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
<h2 is-upgraded>Graceful Shutdown</h2>
<p>Tanzu Application Service (Cloud Foundry)ã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åœæ­¢ã•ã›ã‚‹ãƒ•ãƒ­ãƒ¼ã¯</p>
<ol type="1" start="1">
<li><code>SIGTERM</code>ã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡ (= Ctrl+Cã¨åŒç­‰)</li>
<li>(10ç§’çµŒã£ã¦ã‚‚çµ‚äº†ã—ãªã„å ´åˆ)<code>SIGKILL</code>ã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡</li>
</ol>
<p>ã¨ãªã‚Šã¾ã™ã€‚</p>
<p><a href="https://docs.pivotal.io/platform/application-service/2-8/devguide/deploy-apps/app-lifecycle.html#shutdown" target="_blank">https://docs.pivotal.io/platform/application-service/2-8/devguide/deploy-apps/app-lifecycle.html#shutdown</a></p>
<p>1.ã¨2.ã®é–“ã«æœ€å¤§10ç§’é–“ã®å¾Œå‡¦ç†ãŒè¡Œãˆã¾ã™ã€‚<br>Spring Bootã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ™å‹•ã¯<code>SIGTERM</code>ã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã™ã‚‹ã¨å‡¦ç†ä¸­ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­æ–­çµ‚äº†å‡¦ç†ã«å…¥ã‚Šã¾ã™ã€‚</p>
<p>Spring Boot 2.3ã‹ã‚‰ã¯<code>SIGTERM</code>ã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã™ã‚‹ã¨ã€æ–°è¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å—ã‘ä»˜ã‘ãªã„ãŒã€å‡¦ç†ä¸­ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤Graceful ShutdownãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚<br><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-graceful-shutdown" target="_blank">https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-graceful-shutdown</a></p>
<p>Graceful Shutdownã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã€<code>manifest.yml</code>ã®å¤‰æ›´ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br></p>
<pre><code>applications:
- name: hello-cf
# ç•¥...
  env:
    # â­ï¸â­ï¸â­ï¸
    SERVER_SHUTDOWN: graceful
    SPRING_LIFECYCLE_TIMEOUTPERSHUTDOWNPHASE: 10s
# ç•¥...</code></pre>
<p>ã‚ã‚‹ã„ã¯<code>application.properties</code>ã«</p>
<pre><code>server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=10s</code></pre>
<p>ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
<h2 is-upgraded>è¤‡æ•°è¡Œã®ãƒ­ã‚°ã‚’ä¸€è¡Œã«ã¾ã¨ã‚ã‚‹</h2>
<p>ãƒ­ã‚°ã‚„ä¾‹å¤–ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒè¤‡æ•°è¡Œã«åˆ†ã‹ã‚Œã‚‹å ´åˆã€è»¢é€å…ˆã§ãƒ­ã‚°ã‚’æ¤œç´¢ã—è¾›ããªã‚Šã¾ã™ã€‚è¤‡æ•°ã®ãƒ­ã‚°ã¯ä¸€è¡Œã«ã¾ã¨ã‚ãŸæ–¹ãŒè»¢é€å¾Œã¯ä¾¿åˆ©ã§ã™ã€‚æ¬¡ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚Œã°ã€ä¸€è¡Œã«ã¾ã¨ã¾ã‚Šã¾ã™ã€‚</p>
<pre><code>applications:
- name: hello-cf
# ç•¥...
  env:
    # â­ï¸â­ï¸â­ï¸
    LOGGING_EXCEPTION_CONVERSION_WORD: &#34;\t%replace(%replace(%xEx){&#39;\n&#39;,&#39;@n@&#39;}){&#39;\t&#39;,&#39;    &#39;}%nopex&#34;
    LOGGING_PATTERN_CONSOLE: &#34;%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(${logging.pattern.level:%5p}) %clr(${PID: }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %replace(%m){&#39;\n&#39;,&#39;@n@&#39;}${logging.exception-conversion-word:%wEx}%n&#34;
# ç•¥...</code></pre>
<aside class="special"><p>Note: ä¸Šè¨˜è¨­å®šã§ã¯æ”¹è¡Œã‚³ãƒ¼ãƒ‰(<code>\n</code>)ã‚’<code>@n@</code>ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚’è»¢é€ã™ã‚‹å…ˆã§<code>@n@</code>ã‚’<code>\n</code>ã«æˆ»ã™ã¨ã‚ˆã‚Šè‰¯ã„ã§ã™ã€‚</p>
</aside>
<p>åˆ¥è§£ã¨ã—ã¦ã¯ãƒ­ã‚°ã®å½¢å¼ã‚’JSONã«å¤‰æ›´ã—ã¦ã€æ§‹é€ åŒ–ãƒ­ã‚°ã¨ã—ã¦è»¢é€ã—ã¦ã‚‚è‰¯ã„ã§ã™ã€‚ã“ã®å ´åˆã¯<a href="https://github.com/elastic/ecs-logging-java" target="_blank">ecs-logging-java</a>ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚<br>Spring Bootã‚¢ãƒ—ãƒªã§ä½¿ã†å ´åˆã¯<a href="https://github.com/elastic/ecs-logging-java/blob/master/logback-ecs-encoder/README.md" target="_blank">ã“ã¡ã‚‰</a>ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚</p>
<h2 is-upgraded>ãƒ­ã‚°ã«Trace IDã‚’å«ã‚ã‚‹ &amp; Trace IDã‚’ä¼æ’­ã•ã›ã‚‹</h2>
<p>TBD</p>
<p><code>pom.xml</code></p>
<pre><code>  &lt;properties&gt;
    &lt;java.version&gt;11&lt;/java.version&gt;
    &lt;!-- â­ï¸â­ï¸â­ï¸ --&gt;
    &lt;spring-cloud.version&gt;Hoxton.SR7&lt;/spring-cloud.version&gt;
  &lt;/properties&gt;</code></pre>
<pre><code>  &lt;dependencies&gt;
    &lt;!-- â­ï¸â­ï¸â­ï¸ --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- ç•¥ --&gt;
  &lt;/dependencies&gt;
  &lt;!-- â­ï¸â­ï¸â­ï¸ --&gt;
  &lt;dependencyManagement&gt;
    &lt;dependencies&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
        &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;scope&gt;import&lt;/scope&gt;
      &lt;/dependency&gt;
    &lt;/dependencies&gt;
  &lt;/dependencyManagement&gt;</code></pre>
<p><code>src/main/java/com/example/ApiProperties.java</code></p>
<pre><code>package com.example;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@ConfigurationProperties(prefix = &#34;api&#34;)
public class ApiProperties {

        private String key = &#34;SECRET&#34;;

        private String backendUrl; // â­ï¸â­ï¸â­ï¸

        public String getKey() {
                return key;
        }

        public void setKey(String key) {
                this.key = key;
        }

       // â­ï¸â­ï¸â­ï¸
        public String getBackendUrl() {
                return backendUrl;
        }

        public void setBackendUrl(String backendUrl) {
                this.backendUrl = backendUrl;
        }
}</code></pre>
<p><code>src/main/java/com/example/FrontController.java</code></p>
<pre><code>package com.example;

import com.fasterxml.jackson.databind.JsonNode;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@RestController
public class FrontController {
        private final RestTemplate restTemplate;

        private final Logger log = LoggerFactory.getLogger(FrontController.class);

        public FrontController(RestTemplateBuilder builder, ApiProperties props) {
                this.restTemplate = builder.rootUri(props.getBackendUrl()).build();
        }

        @GetMapping(path = &#34;/front&#34;)
        public JsonNode front() {
                log.info(&#34;Calling backend...&#34;);
                return this.restTemplate.getForObject(&#34;/&#34;, JsonNode.class);
        }
}</code></pre>
<p><code>src/main/resources/application.properties</code>ã«</p>
<pre><code>spring.application.name=hello-cf</code></pre>
<p>ã‚’è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚</p>
<p><code>manifest.yml</code></p>
<pre><code># ...
  env:
  # ...
    API_BACKENDURL: https://demo-api.apps.dev.example.com</code></pre>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã¨pushã‚’ã—ã¾ã™ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true
cf7 push</code></pre>
<p>æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ä½•å›ã‹ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>curl -sv https://${HOST}.apps.dev.example.com/front | jq .</code></pre>
<h2 is-upgraded>Zipkinã«Traceãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹</h2>
<p>TBD</p>
<pre><code>  &lt;dependencies&gt;
    &lt;!-- â­ï¸â­ï¸â­ï¸ --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- ç•¥ --&gt;
  &lt;/dependencies&gt;</code></pre>
<p><code>src/main/resources/application.properties</code>ã«</p>
<pre><code>spring.sleuth.sampler.rate=30</code></pre>
<p>ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br></p>
<pre><code>applications:
- name: hello-cf
# ç•¥...
  env:
    # â­ï¸â­ï¸â­ï¸
    SPRING_ZIPKIN_BASE_URL: https://zipkin.apps.dev.example.com
    SPRING_ZIPKIN_SERVICE_NAME: ${vcap.application.organization_name}:${vcap.application.space_name}:${vcap.application.application_name}
    SPRING_SLEUTH_WEB_ADDITIONALSKIPPATTERN: /actuator.*|/cloudfoundryapplication.*
# ç•¥...</code></pre>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã¨pushã‚’ã—ã¾ã™ã€‚</p>
<pre><code>./mvnw clean package -Dmaven.test.skip=true
cf7 push</code></pre>
<p>æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ä½•å›ã‹ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>curl -sv https://${HOST}.apps.dev.example.com/front | jq .</code></pre>
<p><a href="https://zipkin.apps.dev.example.com" target="_blank">https://zipkin.apps.dev.example.com</a> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<p>ãƒãƒ¼ãƒ å°‚ç”¨ã®Zipkin ServerãŒæ¬²ã—ã„å ´åˆã€åˆ¥é€”ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã§ã™ã€‚</p>
<p><code>zipkin</code>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã€ãã®ä¸‹ã§<code>manifest.yml</code>ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>applications:
- name: zipkin
  memory: 1g
  random-route: true
  docker:
    image: openzipkin/zipkin-slim
  env:
    MEM_MAX_SPANS: 50000</code></pre>
<p>ã“ã‚Œã§<code>cf push</code> / <code>cf7 push</code>ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚</p>
<p>[1] Blueã‚’å‰Šé™¤ã—ãŸå ´åˆã¯ã€éå»ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å†åº¦<code>cf push</code>ã™ã‚Œã°ã§åˆ‡ã‚Šæˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>[2]ã“ã®Service Brokerã¯Productionç’°å¢ƒã§ã®åˆ©ç”¨ã¯æƒ³å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
<p>[3] Dashboardã¯ <a href="https://raw.githubusercontent.com/making/prometheus-kustomize/master/base/grafana/spring-boot.json" target="_blank">https://raw.githubusercontent.com/making/prometheus-kustomize/master/base/grafana/spring-boot.json</a> ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚</p>
<p>[4] ä»–ã«ã‚‚DistributionSummary, LongTaskTimerãªã©ã‚ã‚Šã¾ã™</p>
<p>[5] Counterã§è¡¨ç¾ã§ãã‚‹å ´åˆã¯Gaugeã‚’ä½¿ã‚ãªã„ã§ãã ã•ã„</p>
<p>[6] Timerã§è¡¨ç¾ã§ãã‚‹å ´åˆã¯Counterã‚’ä½¿ã‚ãªã„ã§ãã ã•ã„</p>
<p>[7] ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚åå¿œãŒãªã‘ã‚Œã°åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
<p>[8] Counterã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸå¾Œã®åˆè¨ˆå€¤ã«æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸåˆè¨ˆå€¤ãŒå¤§ãããªã‚‹ã¨å¢—åˆ†ãŒå°ã•ã„å ´åˆã«ã‚°ãƒ©ãƒ•ã§ã¯è¦‹ãˆã¥ã‚‰ããªã‚Šã¾ã™ã€‚</p>
<p>[9] <a href="https://dataflow.cfapps.io/docs/batch-developer-guides/batch/spring-batch/" target="_blank">https://dataflow.cfapps.io/docs/batch-developer-guides/batch/spring-batch/</a> ã®å†…å®¹ã‚’æ”¹å¤‰ã—ã¾ã—ãŸã€‚</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
